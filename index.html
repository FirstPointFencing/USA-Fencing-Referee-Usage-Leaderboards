<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USA Fencing Referee Usage Dashboard</title>
    <!-- Include Papa Parse library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background-color: #1a1a1a;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #ccc;
            font-size: 0.9em;
        }

        .search-container {
            background-color: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-box button {
            padding: 10px 20px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-box button:hover {
            background-color: #0052a3;
        }

        .main-tabs {
            background-color: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            overflow-x: auto;
            padding: 0 20px;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #0066cc;
        }

        .tab-button.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
            font-weight: 600;
        }

        .content-area {
            padding: 20px;
            min-height: 500px;
        }

        .sub-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .sub-tab {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .sub-tab:hover {
            background-color: #e0e0e0;
        }

        .sub-tab.active {
            background-color: #0066cc;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            color: #0066cc;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.9em;
        }

        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f8f8f8;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:not(:first-child):hover {
            background-color: #f0f0f0;
        }

        th.sort-asc::after {
            content: " ↑";
            position: absolute;
            right: 8px;
        }

        th.sort-desc::after {
            content: " ↓";
            position: absolute;
            right: 8px;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .position-number {
            font-weight: 600;
            color: #666;
            width: 50px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background-color: #fee;
            color: #c00;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
        }

        .footer {
            background-color: #1a1a1a;
            color: #ccc;
            padding: 20px;
            text-align: center;
            margin-top: 50px;
            font-size: 0.9em;
        }

        .footer p {
            margin: 5px 0;
        }

        .no-sort {
            cursor: default !important;
        }

        .no-sort:hover {
            background-color: #f8f8f8 !important;
        }

        .weapon-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .weapon-button {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .weapon-button:hover {
            background-color: #e0e0e0;
        }

        .weapon-button.active {
            background-color: #0066cc;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>USA Fencing Referee Usage Dashboard</h1>
        <p>Comprehensive Analysis of National Level Referee Assignments (2014-2025)</p>
    </div>

    <div class="search-container">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search for a referee by name...">
            <button onclick="searchReferees()">Search</button>
            <button onclick="clearSearch()">Clear</button>
        </div>
    </div>

    <div class="main-tabs">
        <button class="tab-button active" onclick="showMainTab('allTime', this)">All Time</button>
        <button class="tab-button" onclick="showMainTab('season2024-25', this)">2024-25</button>
        <button class="tab-button" onclick="showMainTab('season2023-24', this)">2023-24</button>
        <button class="tab-button" onclick="showMainTab('season2022-23', this)">2022-23</button>
        <button class="tab-button" onclick="showMainTab('season2021-22', this)">2021-22</button>
        <button class="tab-button" onclick="showMainTab('season2020-21', this)">2020-21</button>
        <button class="tab-button" onclick="showMainTab('season2019-20', this)">2019-20</button>
        <button class="tab-button" onclick="showMainTab('season2018-19', this)">2018-19</button>
        <button class="tab-button" onclick="showMainTab('season2017-18', this)">2017-18</button>
        <button class="tab-button" onclick="showMainTab('season2016-17', this)">2016-17</button>
        <button class="tab-button" onclick="showMainTab('season2015-16', this)">2015-16</button>
        <button class="tab-button" onclick="showMainTab('season2014-15', this)">2014-15</button>
        <button class="tab-button" onclick="showMainTab('tournaments', this)">Tournament Usage</button>
        <button class="tab-button" onclick="showMainTab('finalsAllTime', this)">Finals All Time</button>
    </div>

    <div class="content-area" id="contentArea">
        <div class="loading">Loading referee data...</div>
    </div>

    <div class="footer">
        <p><strong>Project Credits:</strong></p>
        <p>K. Hone: Data streamlining and design</p>
        <p>M. Tucker Ph.D: Data advisor</p>
        <p>C. Cheney: Creator, project design</p>
        <p>Please submit any noticed discrepancies, inconsistencies, or suggestions to C. Cheney</p>
    </div>

    <script>
        // Global data storage
        let allData = [];
        let currentTab = 'allTime';
        let currentSubTab = 'overall';
        let searchTerm = '';

        // CSV file mapping
        const fileMapping = {
            '2014-15': ['Referee_Usage_20142015.csv'],
            '2015-16': ['Referee_Usage_20152016.csv'],
            '2016-17': ['Referee_Usage_20162017.csv'],
            '2017-18': ['Referee_Usage_20172018.csv'],
            '2018-19': ['Referee_Usage_20182019.csv'],
            '2019-20': ['Referee_Usage_20192020.csv'],
            '2020-21': ['Referee_Usage_20202021.csv'],
            '2021-22': ['Referee_Usage_20212022.csv'],
            '2022-23': ['Referee_Usage_20222023_Part1.csv', 'Referee_Usage_20222023_Part2.csv'],
            '2023-24': ['Referee_Usage_20232024_Part1.csv', 'Referee_Usage_20232024_Part2.csv'],
            '2024-25': ['Referee_Usage_20242025.csv', 'Referee_Usage_20242025_Part1.csv', 'Referee_Usage_20242025_Part2.csv']
        };

        // Tournament mapping by month
        const tournamentMapping = {
            'October NAC': { months: [10], name: 'October NAC' },
            'November NAC': { months: [11], name: 'November NAC' },
            'December NAC/SJCC': { months: [12], name: 'December NAC/SJCC' },
            'January NAC': { months: [1], name: 'January NAC' },
            'Jr Olympics': { months: [2], name: 'Jr Olympics' },
            'March NAC/SJCC': { months: [3], name: 'March NAC/SJCC' },
            'April NAC': { months: [4], name: 'April NAC' },
            'May SJCC': { months: [5], name: 'May SJCC' },
            'June NAC/SJCC': { months: [6], name: 'June NAC/SJCC' },
            'Summer Nationals': { months: [7], name: 'Summer Nationals', special: true }
        };

        // Initialize the dashboard
        async function initDashboard() {
            try {
                await loadAllData();
                showMainTab('allTime');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="error">
                        <h3>Error Loading Data</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Load all CSV data
        async function loadAllData() {
            allData = [];
            let loadedCount = 0;
            let totalFiles = 0;

            for (const season in fileMapping) {
                totalFiles += fileMapping[season].length;
            }

            for (const season in fileMapping) {
                for (const file of fileMapping[season]) {
                    try {
                        const data = await loadCSV(file);
                        if (data && data.length > 0) {
                            // Add season info to each record
                            data.forEach(row => {
                                row.season = season;
                                row.fileName = file;
                            });
                            allData = allData.concat(data);
                            loadedCount++;
                        }
                    } catch (error) {
                        console.warn(`Could not load ${file}:`, error);
                    }
                }
            }

            console.log(`Successfully loaded ${loadedCount} out of ${totalFiles} files`);
            console.log(`Total records: ${allData.length}`);
        }

        // Load and parse CSV file
        async function loadCSV(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                
                return new Promise((resolve, reject) => {
                    if (typeof Papa === 'undefined') {
                        reject(new Error('Papa Parse library not loaded'));
                        return;
                    }
                    
                    Papa.parse(text, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            resolve(processCSVData(results.data, results.meta.fields));
                        },
                        error: (error) => {
                            reject(error);
                        }
                    });
                });
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                return [];
            }
        }

        // Process CSV data according to special rules
        function processCSVData(data, headers) {
            return data.map(row => {
                const processed = {
                    lastName: row['Last Name'] || row[''] || '',
                    firstName: row['First Name'] || '',
                    date: row['Date'] || '',
                    event: row['Event'] || '',
                    pools: 0,
                    bouts: {},
                    videoRef: 0,
                    ref: 0,
                    top8: 0,
                    finals: 0
                };

                // Handle duplicate Pools columns
                let poolCount = 0;
                headers.forEach(header => {
                    if (header && header.toLowerCase().includes('pool')) {
                        const value = row[header];
                        if (value && typeof value === 'string') {
                            const match = value.match(/Ref:\s*(\d+)/);
                            if (match) {
                                poolCount += parseInt(match[1]);
                            }
                        }
                    }
                });
                processed.pools = poolCount;

                // Process table rounds
                const rounds = ['Table of 512', 'Table of 256', 'Table of 128', 'Table of 64', 
                               'Table of 32', 'Table of 16', 'Table of 8', 'Semi-Finals', 
                               'Bronze Medal Matches', 'Finals'];

                rounds.forEach(round => {
                    let refCount = 0;
                    let videoCount = 0;

                    // Check all columns that might contain this round
                    headers.forEach(header => {
                        if (header && header.includes(round)) {
                            const value = row[header];
                            if (value && typeof value === 'string') {
                                if (value.includes('Video')) {
                                    const match = value.match(/Video:\s*(\d+)/);
                                    if (match) videoCount += parseInt(match[1]);
                                } else if (value.includes('Ref')) {
                                    const match = value.match(/Ref:\s*(\d+)/);
                                    if (match) refCount += parseInt(match[1]);
                                }
                            }
                        }
                    });

                    if (refCount > 0 || videoCount > 0) {
                        processed.bouts[round] = { ref: refCount, video: videoCount };
                        processed.ref += refCount;
                        processed.videoRef += videoCount;

                        // Count Top 8 (Quarter-finals and Semi-finals)
                        if (round === 'Table of 8' || round === 'Semi-Finals' || round === 'Finals') {
                            processed.top8 += refCount + videoCount;
                        }

                        // Count Finals
                        if (round === 'Finals') {
                            processed.finals += refCount + videoCount;
                        }
                    }
                });

                // Parse date
                if (processed.date) {
                    const dateParts = processed.date.split('/');
                    if (dateParts.length === 3) {
                        processed.month = parseInt(dateParts[0]);
                        processed.day = parseInt(dateParts[1]);
                        processed.year = parseInt(dateParts[2]);
                    }
                }

                // Extract weapon from event code
                if (processed.event) {
                    if (processed.event.includes('MS')) processed.weapon = 'Saber';
                    else if (processed.event.includes('WS')) processed.weapon = 'Saber';
                    else if (processed.event.includes('ME')) processed.weapon = 'Epee';
                    else if (processed.event.includes('WE')) processed.weapon = 'Epee';
                    else if (processed.event.includes('MF')) processed.weapon = 'Foil';
                    else if (processed.event.includes('WF')) processed.weapon = 'Foil';
                    else processed.weapon = 'Unknown';
                }

                return processed;
            }).filter(row => row.lastName || row.firstName); // Filter out empty rows
        }

        // Aggregate referee data
        function aggregateRefereeData(data, filterFn = null) {
            const filtered = filterFn ? data.filter(filterFn) : data;
            const referees = {};

            filtered.forEach(row => {
                const key = `${row.lastName}|${row.firstName}`;
                if (!referees[key]) {
                    referees[key] = {
                        lastName: row.lastName,
                        firstName: row.firstName,
                        ref: 0,
                        pools: 0,
                        videoRef: 0,
                        top8: 0,
                        finals: 0,
                        tournaments: new Set(),
                        events: new Set(),
                        seasons: new Set(),
                        weapons: { Saber: 0, Epee: 0, Foil: 0 }
                    };
                }

                referees[key].ref += row.ref;
                referees[key].pools += row.pools;
                referees[key].videoRef += row.videoRef;
                referees[key].top8 += row.top8;
                referees[key].finals += row.finals;

                // Track unique tournaments and events
                if (row.date) {
                    referees[key].tournaments.add(`${row.date}-${row.event}`);
                }
                if (row.event) {
                    referees[key].events.add(row.event);
                }
                if (row.season) {
                    referees[key].seasons.add(row.season);
                }

                // Track weapon usage
                if (row.weapon && row.weapon !== 'Unknown') {
                    referees[key].weapons[row.weapon] += row.ref + row.videoRef;
                }
            });

            // Convert sets to counts
            return Object.values(referees).map(ref => ({
                ...ref,
                totalBouts: ref.ref + ref.videoRef,
                tournamentsCount: ref.tournaments.size,
                eventsCount: ref.events.size,
                seasonsCount: ref.seasons.size,
                videoPercentage: ref.ref + ref.videoRef > 0 
                    ? ((ref.videoRef / (ref.ref + ref.videoRef)) * 100).toFixed(1) 
                    : 0
            }));
        }

        // Show main tab
        function showMainTab(tab, buttonElement) {
            currentTab = tab;
            
            // Update active tab styling
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find the button if not provided
            if (!buttonElement) {
                buttonElement = document.querySelector(`.tab-button[onclick*="${tab}"]`);
            }
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Show appropriate content
            const contentArea = document.getElementById('contentArea');
            
            if (tab === 'allTime') {
                showAllTimeContent();
            } else if (tab.startsWith('season')) {
                const season = tab.replace('season', '');
                showSeasonContent(season);
            } else if (tab === 'tournaments') {
                showTournamentContent();
            } else if (tab === 'finalsAllTime') {
                showFinalsAllTimeContent();
            }
        }

        // Show all-time content
        function showAllTimeContent() {
            const aggregated = aggregateRefereeData(allData);
            const stats = calculateStats(allData);

            const content = `
                <div class="sub-tabs">
                    <button class="sub-tab active" onclick="showAllTimeSubTab('overall', this)">Overall</button>
                    <button class="sub-tab" onclick="showAllTimeSubTab('saber', this)">Saber</button>
                    <button class="sub-tab" onclick="showAllTimeSubTab('epee', this)">Epee</button>
                    <button class="sub-tab" onclick="showAllTimeSubTab('foil', this)">Foil</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${stats.totalReferees}</h3>
                        <p>Total Referees</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalBouts.toLocaleString()}</h3>
                        <p>Total Bouts</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalFinals}</h3>
                        <p>Total Finals</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalEvents}</h3>
                        <p>Total Events</p>
                    </div>
                </div>
                
                <div id="allTimeTableContainer"></div>
            `;

            document.getElementById('contentArea').innerHTML = content;
            showAllTimeSubTab('overall');
        }

        // Show all-time sub-tab
        function showAllTimeSubTab(weapon, buttonElement) {
            currentSubTab = weapon;
            
            // Update sub-tab styling
            document.querySelectorAll('.sub-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find the button if not provided
            if (!buttonElement) {
                buttonElement = document.querySelector(`.sub-tab[onclick*="${weapon}"]`);
            }
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            let aggregated;
            if (weapon === 'overall') {
                aggregated = aggregateRefereeData(allData);
            } else {
                aggregated = aggregateRefereeData(allData, row => 
                    row.weapon && row.weapon.toLowerCase() === weapon
                );
            }

            // Sort by total bouts descending
            aggregated.sort((a, b) => b.totalBouts - a.totalBouts);

            // Show top 150
            const top150 = aggregated.slice(0, 150);

            const tableHtml = `
                <div class="table-container">
                    <table id="allTimeTable">
                        <thead>
                            <tr>
                                <th class="no-sort">#</th>
                                <th class="no-sort">Name</th>
                                <th onclick="sortTable('allTimeTable', 2, 'number')">Ref</th>
                                <th onclick="sortTable('allTimeTable', 3, 'number')">Pools</th>
                                <th onclick="sortTable('allTimeTable', 4, 'number')">Video Ref</th>
                                <th onclick="sortTable('allTimeTable', 5, 'number')">Top 8</th>
                                <th onclick="sortTable('allTimeTable', 6, 'number')">Finals</th>
                                <th onclick="sortTable('allTimeTable', 7, 'number')">% Video</th>
                                <th onclick="sortTable('allTimeTable', 8, 'number')">Seasons</th>
                                <th onclick="sortTable('allTimeTable', 9, 'number')">Tournaments</th>
                                <th onclick="sortTable('allTimeTable', 10, 'number')">Events</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${top150.map((ref, index) => `
                                <tr>
                                    <td class="position-number">${index + 1}</td>
                                    <td>${ref.lastName}, ${ref.firstName}</td>
                                    <td>${ref.ref}</td>
                                    <td>${ref.pools}</td>
                                    <td>${ref.videoRef}</td>
                                    <td>${ref.top8}</td>
                                    <td>${ref.finals}</td>
                                    <td>${ref.videoPercentage}%</td>
                                    <td>${ref.seasonsCount}</td>
                                    <td>${ref.tournamentsCount}</td>
                                    <td>${ref.eventsCount}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('allTimeTableContainer').innerHTML = tableHtml;
        }

        // Show season content
        function showSeasonContent(season) {
            const seasonData = allData.filter(row => row.season === season);
            const stats = calculateStats(seasonData);

            const content = `
                <div class="sub-tabs">
                    <button class="sub-tab active" onclick="showSeasonSubTab('${season}', 'overall')">Overall</button>
                    <button class="sub-tab" onclick="showSeasonSubTab('${season}', 'saber')">Saber</button>
                    <button class="sub-tab" onclick="showSeasonSubTab('${season}', 'epee')">Epee</button>
                    <button class="sub-tab" onclick="showSeasonSubTab('${season}', 'foil')">Foil</button>
                    <button class="sub-tab" onclick="showSeasonSubTab('${season}', 'finals')">Finals</button>
                    <button class="sub-tab" onclick="showSeasonSubTab('${season}', 'events')">By Event</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${stats.totalReferees}</h3>
                        <p>Active Referees This Season</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalBouts.toLocaleString()}</h3>
                        <p>Total Bouts This Season</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalFinals}</h3>
                        <p>Finals Officiated This Season</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalEvents}</h3>
                        <p>Events This Season</p>
                    </div>
                </div>
                
                <div id="seasonTableContainer"></div>
            `;

            document.getElementById('contentArea').innerHTML = content;
            showSeasonSubTab(season, 'overall');
        }

        // Show season sub-tab
        function showSeasonSubTab(season, view) {
            const seasonData = allData.filter(row => row.season === season);

            if (view === 'events') {
                showSeasonEventBreakdown(season, seasonData);
                return;
            }

            if (view === 'finals') {
                showSeasonFinals(season, seasonData);
                return;
            }

            let filtered = seasonData;
            if (view !== 'overall') {
                filtered = seasonData.filter(row => 
                    row.weapon && row.weapon.toLowerCase() === view
                );
            }

            const aggregated = aggregateRefereeData(filtered);
            aggregated.sort((a, b) => b.totalBouts - a.totalBouts);

            const top50 = aggregated.slice(0, 50);

            const tableHtml = `
                <div class="table-container">
                    <table id="seasonTable">
                        <thead>
                            <tr>
                                <th class="no-sort">#</th>
                                <th class="no-sort">Name</th>
                                <th onclick="sortTable('seasonTable', 2, 'number')">Ref</th>
                                <th onclick="sortTable('seasonTable', 3, 'number')">Pools</th>
                                <th onclick="sortTable('seasonTable', 4, 'number')">Video Ref</th>
                                <th onclick="sortTable('seasonTable', 5, 'number')">Top 8</th>
                                <th onclick="sortTable('seasonTable', 6, 'number')">Finals</th>
                                <th onclick="sortTable('seasonTable', 7, 'number')">% Video</th>
                                <th onclick="sortTable('seasonTable', 8, 'number')">Tournaments</th>
                                <th onclick="sortTable('seasonTable', 9, 'number')">Events</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${top50.map((ref, index) => `
                                <tr>
                                    <td class="position-number">${index + 1}</td>
                                    <td>${ref.lastName}, ${ref.firstName}</td>
                                    <td>${ref.ref}</td>
                                    <td>${ref.pools}</td>
                                    <td>${ref.videoRef}</td>
                                    <td>${ref.top8}</td>
                                    <td>${ref.finals}</td>
                                    <td>${ref.videoPercentage}%</td>
                                    <td>${ref.tournamentsCount}</td>
                                    <td>${ref.eventsCount}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('seasonTableContainer').innerHTML = tableHtml;
        }

        // Show season finals
        function showSeasonFinals(season, seasonData) {
            const finalsData = seasonData.filter(row => row.finals > 0);
            const aggregated = aggregateRefereeData(finalsData);
            aggregated.sort((a, b) => b.finals - a.finals);

            const tableHtml = `
                <div class="table-container">
                    <table id="seasonFinalsTable">
                        <thead>
                            <tr>
                                <th class="no-sort">#</th>
                                <th class="no-sort">Name</th>
                                <th onclick="sortTable('seasonFinalsTable', 2, 'number')">Gold Medal Matches</th>
                                <th onclick="sortTable('seasonFinalsTable', 3, 'number')">As Ref</th>
                                <th onclick="sortTable('seasonFinalsTable', 4, 'number')">As Video</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aggregated.map((ref, index) => `
                                <tr>
                                    <td class="position-number">${index + 1}</td>
                                    <td>${ref.lastName}, ${ref.firstName}</td>
                                    <td>${ref.finals}</td>
                                    <td>${ref.ref}</td>
                                    <td>${ref.videoRef}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('seasonTableContainer').innerHTML = tableHtml;
        }

        // Show tournament content
        function showTournamentContent() {
            const tournaments = groupByTournament(allData);
            const sortedTournaments = Object.entries(tournaments)
                .sort((a, b) => {
                    // Sort by date descending (most recent first)
                    const dateA = new Date(a[1][0].year, a[1][0].month - 1);
                    const dateB = new Date(b[1][0].year, b[1][0].month - 1);
                    return dateB - dateA;
                });

            const content = `
                <h2>Tournament Usage</h2>
                <div class="sub-tabs">
                    ${sortedTournaments.map(([name, data]) => `
                        <button class="sub-tab" onclick="showTournamentDetail('${name}', this)">
                            ${name}
                        </button>
                    `).join('')}
                </div>
                <div id="tournamentDetailContainer"></div>
            `;

            document.getElementById('contentArea').innerHTML = content;
            
            // Show first tournament by default
            if (sortedTournaments.length > 0) {
                showTournamentDetail(sortedTournaments[0][0]);
                document.querySelector('.sub-tab').classList.add('active');
            }
        }

        // Group data by tournament
        function groupByTournament(data) {
            const tournaments = {};

            data.forEach(row => {
                if (!row.month || !row.year) return;

                let tournamentName = null;
                
                // Check Summer Nationals special case
                if (row.month === 6 || row.month === 7) {
                    const date = new Date(row.year, row.month - 1, row.day);
                    const startDate = new Date(row.year, 5, 27); // June 27
                    const endDate = new Date(row.year, 6, 13); // July 13
                    
                    if (date >= startDate && date <= endDate) {
                        tournamentName = `Summer Nationals ${row.year}`;
                    }
                }

                // Check regular tournaments
                if (!tournamentName) {
                    for (const [key, config] of Object.entries(tournamentMapping)) {
                        if (config.months.includes(row.month)) {
                            tournamentName = `${config.name} ${row.year}`;
                            break;
                        }
                    }
                }

                if (tournamentName) {
                    if (!tournaments[tournamentName]) {
                        tournaments[tournamentName] = [];
                    }
                    tournaments[tournamentName].push(row);
                }
            });

            return tournaments;
        }

        // Show tournament detail
        function showTournamentDetail(tournamentName, buttonElement) {
            // Update active button
            if (buttonElement) {
                document.querySelectorAll('.sub-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                buttonElement.classList.add('active');
            }

            const tournaments = groupByTournament(allData);
            const tournamentData = tournaments[tournamentName] || [];
            
            const aggregated = aggregateRefereeData(tournamentData);
            aggregated.sort((a, b) => b.totalBouts - a.totalBouts);

            const stats = calculateStats(tournamentData);

            const tableHtml = `
                <h3>${tournamentName}</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${stats.totalReferees}</h3>
                        <p>Referees Used</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalBouts.toLocaleString()}</h3>
                        <p>Total Bouts</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalFinals}</h3>
                        <p>Finals</p>
                    </div>
                </div>
                
                <div class="weapon-filter">
                    <button class="weapon-button active" onclick="filterTournamentByWeapon('${tournamentName}', 'all', this)">All Weapons</button>
                    <button class="weapon-button" onclick="filterTournamentByWeapon('${tournamentName}', 'saber', this)">Saber</button>
                    <button class="weapon-button" onclick="filterTournamentByWeapon('${tournamentName}', 'epee', this)">Epee</button>
                    <button class="weapon-button" onclick="filterTournamentByWeapon('${tournamentName}', 'foil', this)">Foil</button>
                </div>
                
                <div class="table-container">
                    <table id="tournamentTable">
                        <thead>
                            <tr>
                                <th class="no-sort">#</th>
                                <th class="no-sort">Name</th>
                                <th onclick="sortTable('tournamentTable', 2, 'number')">Ref</th>
                                <th onclick="sortTable('tournamentTable', 3, 'number')">Pools</th>
                                <th onclick="sortTable('tournamentTable', 4, 'number')">Video Ref</th>
                                <th onclick="sortTable('tournamentTable', 5, 'number')">Top 8</th>
                                <th onclick="sortTable('tournamentTable', 6, 'number')">Finals</th>
                                <th onclick="sortTable('tournamentTable', 7, 'number')">% Video</th>
                                <th onclick="sortTable('tournamentTable', 8, 'number')">Events</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aggregated.map((ref, index) => `
                                <tr>
                                    <td class="position-number">${index + 1}</td>
                                    <td>${ref.lastName}, ${ref.firstName}</td>
                                    <td>${ref.ref}</td>
                                    <td>${ref.pools}</td>
                                    <td>${ref.videoRef}</td>
                                    <td>${ref.top8}</td>
                                    <td>${ref.finals}</td>
                                    <td>${ref.videoPercentage}%</td>
                                    <td>${ref.eventsCount}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('tournamentDetailContainer').innerHTML = tableHtml;
        }

        // Filter tournament by weapon
        function filterTournamentByWeapon(tournamentName, weapon, buttonElement) {
            // Update active button
            document.querySelectorAll('.weapon-button').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonElement.classList.add('active');

            const tournaments = groupByTournament(allData);
            let tournamentData = tournaments[tournamentName] || [];
            
            if (weapon !== 'all') {
                tournamentData = tournamentData.filter(row => 
                    row.weapon && row.weapon.toLowerCase() === weapon
                );
            }

            const aggregated = aggregateRefereeData(tournamentData);
            aggregated.sort((a, b) => b.totalBouts - a.totalBouts);

            // Update table body
            const tbody = document.querySelector('#tournamentTable tbody');
            tbody.innerHTML = aggregated.map((ref, index) => `
                <tr>
                    <td class="position-number">${index + 1}</td>
                    <td>${ref.lastName}, ${ref.firstName}</td>
                    <td>${ref.ref}</td>
                    <td>${ref.pools}</td>
                    <td>${ref.videoRef}</td>
                    <td>${ref.top8}</td>
                    <td>${ref.finals}</td>
                    <td>${ref.videoPercentage}%</td>
                    <td>${ref.eventsCount}</td>
                </tr>
            `).join('');
        }

        // Show finals all-time content
        function showFinalsAllTimeContent() {
            const finalsData = allData.filter(row => row.finals > 0);
            const aggregated = aggregateRefereeData(finalsData);
            aggregated.sort((a, b) => b.finals - a.finals);

            const totalFinals = aggregated.reduce((sum, ref) => sum + ref.finals, 0);

            const content = `
                <h2>Finals All Time (2014-2025)</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${totalFinals}</h3>
                        <p>Total Gold Medal Matches</p>
                    </div>
                    <div class="stat-card">
                        <h3>${aggregated.length}</h3>
                        <p>Referees Who Officiated Finals</p>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="finalsTable">
                        <thead>
                            <tr>
                                <th class="no-sort">#</th>
                                <th class="no-sort">Name</th>
                                <th onclick="sortTable('finalsTable', 2, 'number')">Total Gold Medal Matches</th>
                                <th onclick="sortTable('finalsTable', 3, 'number')">As Ref</th>
                                <th onclick="sortTable('finalsTable', 4, 'number')">As Video</th>
                                <th onclick="sortTable('finalsTable', 5, 'number')">Total Top 8 Bouts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aggregated.map((ref, index) => `
                                <tr>
                                    <td class="position-number">${index + 1}</td>
                                    <td>${ref.lastName}, ${ref.firstName}</td>
                                    <td>${ref.finals}</td>
                                    <td>${ref.ref}</td>
                                    <td>${ref.videoRef}</td>
                                    <td>${ref.top8}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('contentArea').innerHTML = content;
        }

        // Calculate statistics
        function calculateStats(data) {
            const uniqueReferees = new Set();
            const uniqueEvents = new Set();
            let totalBouts = 0;
            let totalFinals = 0;

            data.forEach(row => {
                uniqueReferees.add(`${row.lastName}|${row.firstName}`);
                if (row.event) uniqueEvents.add(row.event);
                totalBouts += row.ref + row.videoRef;
                totalFinals += row.finals;
            });

            return {
                totalReferees: uniqueReferees.size,
                totalEvents: uniqueEvents.size,
                totalBouts: totalBouts,
                totalFinals: totalFinals
            };
        }

        // Sort table function
        function sortTable(tableId, columnIndex, type) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const th = table.querySelectorAll('th')[columnIndex];
            
            // Determine sort direction
            const isAscending = th.classList.contains('sort-asc');
            
            // Remove sort indicators from all headers
            table.querySelectorAll('th').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                let comparison = 0;
                if (type === 'number') {
                    const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, '')) || 0;
                    const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, '')) || 0;
                    comparison = aNum - bNum;
                } else {
                    comparison = aValue.localeCompare(bValue);
                }
                
                return isAscending ? -comparison : comparison;
            });
            
            // Update sort indicator
            th.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
            
            // Re-append sorted rows
            rows.forEach((row, index) => {
                // Update position numbers
                const positionCell = row.cells[0];
                if (positionCell.classList.contains('position-number')) {
                    positionCell.textContent = index + 1;
                }
                tbody.appendChild(row);
            });
        }

        // Search functions
        function searchReferees() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            refreshCurrentView();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            refreshCurrentView();
        }

        function refreshCurrentView() {
            // Re-render current view with search filter
            const activeButton = document.querySelector('.tab-button.active');
            if (activeButton) {
                activeButton.click();
            } else {
                showMainTab(currentTab);
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Check if Papa Parse is loaded
            if (typeof Papa === 'undefined') {
                console.error('Papa Parse library not loaded. Retrying...');
                // Try loading Papa Parse again
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js';
                script.onload = function() {
                    initDashboard();
                };
                script.onerror = function() {
                    document.getElementById('contentArea').innerHTML = `
                        <div class="error">
                            <h3>Error Loading Required Libraries</h3>
                            <p>Could not load Papa Parse library. Please check your internet connection and refresh the page.</p>
                        </div>
                    `;
                };
                document.head.appendChild(script);
            } else {
                initDashboard();
            }
        });
    </script>
</body>
</html>