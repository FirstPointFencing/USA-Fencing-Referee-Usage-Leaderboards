<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USA Fencing Referee Usage Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #1e3c72;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #1e3c72;
        }
        
        .tabs-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab:hover {
            background: #e8e8e8;
        }
        
        .tab.active {
            background: white;
            color: #1e3c72;
            font-weight: bold;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #1e3c72;
        }
        
        .sub-tabs {
            display: flex;
            flex-wrap: wrap;
            background: #fafafa;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sub-tab {
            padding: 8px 15px;
            margin: 0 5px;
            cursor: pointer;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .sub-tab:hover {
            background: #f0f0f0;
        }
        
        .sub-tab.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }
        
        .tab-content {
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #1e3c72;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: #2a5298;
        }
        
        th.sorted-asc::after {
            content: ' ‚Üë';
        }
        
        th.sorted-desc::after {
            content: ' ‚Üì';
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        tr:nth-child(even) {
            background: #fafafa;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #666;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #1e3c72;
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
            
            .table-container {
                overflow-x: scroll;
            }
            
            table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§∫ USA Fencing Referee Usage Dashboard</h1>
            <p>Comprehensive Analysis of National Event Referee Usage (2014-2025)</p>
        </div>
        
        <div class="stats-cards" id="statsCards">
            <div class="stat-card">
                <h3>Total Referees</h3>
                <div class="value" id="totalReferees">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Bouts</h3>
                <div class="value" id="totalBouts">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Events</h3>
                <div class="value" id="totalEvents">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Seasons</h3>
                <div class="value" id="totalSeasons">-</div>
            </div>
        </div>
        
        <div class="tabs-container">
            <div class="tabs" id="mainTabs">
                <button class="tab active" data-tab="all-time">All Time</button>
                <button class="tab" data-tab="2024-25">2024-25</button>
                <button class="tab" data-tab="2023-24">2023-24</button>
                <button class="tab" data-tab="2022-23">2022-23</button>
                <button class="tab" data-tab="2021-22">2021-22</button>
                <button class="tab" data-tab="2020-21">2020-21</button>
                <button class="tab" data-tab="2019-20">2019-20</button>
                <button class="tab" data-tab="2018-19">2018-19</button>
                <button class="tab" data-tab="2017-18">2017-18</button>
                <button class="tab" data-tab="2016-17">2016-17</button>
                <button class="tab" data-tab="2015-16">2015-16</button>
                <button class="tab" data-tab="2014-15">2014-15</button>
                <button class="tab" data-tab="tournaments">Tournaments</button>
            </div>
            
            <div class="tab-content active" id="all-time">
                <div class="sub-tabs">
                    <button class="sub-tab active" data-subtab="overall">Overall</button>
                    <button class="sub-tab" data-subtab="foil">Foil</button>
                    <button class="sub-tab" data-subtab="epee">Epee</button>
                    <button class="sub-tab" data-subtab="saber">Saber</button>
                    <button class="sub-tab" data-subtab="finals">Finals Leaders</button>
                </div>
                
                <div class="filters">
                    <div class="search-box">
                        <input type="text" id="searchAll" placeholder="Search referee...">
                    </div>
                    <div class="filter-group">
                        <label>Min Bouts:</label>
                        <input type="number" id="minBoutsAll" min="0" value="0">
                    </div>
                </div>
                
                <div class="table-container">
                    <div id="allTimeTable" class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading referee data from GitHub...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                        <p id="loadingStatus">Initializing...</p>
                    </div>
                </div>
            </div>
            
            <!-- Season tabs will be populated dynamically -->
            <div class="tab-content" id="2024-25"></div>
            <div class="tab-content" id="2023-24"></div>
            <div class="tab-content" id="2022-23"></div>
            <div class="tab-content" id="2021-22"></div>
            <div class="tab-content" id="2020-21"></div>
            <div class="tab-content" id="2019-20"></div>
            <div class="tab-content" id="2018-19"></div>
            <div class="tab-content" id="2017-18"></div>
            <div class="tab-content" id="2016-17"></div>
            <div class="tab-content" id="2015-16"></div>
            <div class="tab-content" id="2014-15"></div>
            <div class="tab-content" id="tournaments"></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script>
        let allData = [];
        let aggregatedData = {};
        let currentSort = { column: null, direction: 'desc' };
        
        // GitHub raw content base URL
        const GITHUB_BASE = 'https://raw.githubusercontent.com/FirstPointFencing/USA-Fencing-Referee-Usage-Leaderboards/main/';
        
        // List of CSV files to load
        const files = [
            { file: 'Referee_Usage_20142015.csv', season: '2014-15' },
            { file: 'Referee_Usage_20152016.csv', season: '2015-16' },
            { file: 'Referee_Usage_20162017.csv', season: '2016-17' },
            { file: 'Referee_Usage_20172018.csv', season: '2017-18' },
            { file: 'Referee_Usage_20182019.csv', season: '2018-19' },
            { file: 'Referee_Usage_20192020.csv', season: '2019-20' },
            { file: 'Referee_Usage_20202021.csv', season: '2020-21' },
            { file: 'Referee_Usage_20212022.csv', season: '2021-22' },
            { file: 'Referee_Usage_20222023_Part1.csv', season: '2022-23' },
            { file: 'Referee_Usage_20222023_Part2.csv', season: '2022-23' },
            { file: 'Referee_Usage_20232024_Part1.csv', season: '2023-24' },
            { file: 'Referee_Usage_20232024_Part2.csv', season: '2023-24' },
            { file: 'Referee_Usage_20242025_Part1.csv', season: '2024-25' },
            { file: 'Referee_Usage_20242025_Part2.csv', season: '2024-25' }
        ];
        
        // Helper function to extract number from string like "Ref: 2" or "Video: 1"
        function extractNumber(str) {
            if (!str || str === null || str === undefined) return 0;
            const match = String(str).match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }
        
        // Helper to determine if it's video or ref
        function isVideo(str) {
            if (!str || str === null) return false;
            return String(str).toLowerCase().includes('video');
        }
        
        // Function to determine tournament from date
        function determineTournament(date) {
            if (!date) return 'Unknown';
            
            const parts = date.split('/');
            if (parts.length !== 3) return 'Unknown';
            
            const month = parseInt(parts[0]);
            const day = parseInt(parts[1]);
            
            switch (month) {
                case 10: return 'October NAC';
                case 11: return 'November NAC';
                case 12: return 'December NAC/SJCC';
                case 1: return 'January NAC';
                case 2: return 'Jr Olympics';
                case 3: return 'March NAC/SJCC';
                case 4: return 'April NAC';
                case 5: return 'May SJCC';
                case 6: return 'June NAC/SJCC';
                case 7: return 'Summer Nationals';
                default: return 'Unknown';
            }
        }
        
        // Process a single row of data
        function processRow(row, season) {
            // Clean up the row
            const cleanRow = {};
            for (let key in row) {
                if (key) {
                    const cleanKey = key.trim();
                    cleanRow[cleanKey] = row[key];
                }
            }
            
            // Standardize name fields
            let lastName = cleanRow['Last Name'] || cleanRow[''] || '';
            let firstName = cleanRow['First Name'] || '';
            
            // Skip if no name
            if (!lastName && !firstName) return null;
            
            // Get event info
            const event = cleanRow['Event'] || '';
            const date = cleanRow['Date'] || '';
            
            // Extract weapon from event code
            let weapon = '';
            if (event.includes('MS') || event.includes('WS')) {
                weapon = 'Saber';
            } else if (event.includes('ME') || event.includes('WE')) {
                weapon = 'Epee';
            } else if (event.includes('MF') || event.includes('WF')) {
                weapon = 'Foil';
            }
            
            // Process match data
            const processedRow = {
                lastName: lastName.trim(),
                firstName: firstName.trim(),
                fullName: `${lastName.trim()}, ${firstName.trim()}`.trim(),
                season: season,
                event: event,
                date: date,
                weapon: weapon,
                pools: 0,
                refBouts: 0,
                videoBouts: 0,
                finals: 0,
                bronzeMedals: 0,
                top8: 0,
                tournament: determineTournament(date)
            };
            
            // Process Pools (combine multiple pool columns as per instructions)
            const poolKeys = Object.keys(cleanRow).filter(k => k && k.includes('Pool'));
            for (const key of poolKeys) {
                processedRow.pools += extractNumber(cleanRow[key]);
            }
            
            // Process Table rounds (combine duplicate Table of 128 columns as per instructions)
            const tableRounds = [
                'Table of 512', 'Table of 256', 'Table of 128', 'Table of 128_1',
                'Table of 64', 'Table of 32', 'Table of 16', 'Table of 8',
                'Semi-Finals'
            ];
            
            for (const round of tableRounds) {
                const value = cleanRow[round];
                if (value) {
                    const num = extractNumber(value);
                    if (isVideo(value)) {
                        processedRow.videoBouts += num;
                    } else {
                        processedRow.refBouts += num;
                    }
                    
                    // Count top 8 (Table of 8 and Semi-Finals)
                    if (round === 'Table of 8' || round === 'Semi-Finals') {
                        processedRow.top8 += num;
                    }
                }
            }
            
            // Process Finals (Gold Medal Match only as per instructions)
            const finalsValue = cleanRow['Finals'];
            if (finalsValue) {
                const num = extractNumber(finalsValue);
                processedRow.finals += num;
                processedRow.top8 += num; // Finals count in top 8
                if (isVideo(finalsValue)) {
                    processedRow.videoBouts += num;
                } else {
                    processedRow.refBouts += num;
                }
            }
            
            // Process Bronze Medal Matches
            const bronzeValue = cleanRow['Bronze Medal Matches'];
            if (bronzeValue) {
                const num = extractNumber(bronzeValue);
                processedRow.bronzeMedals += num;
                if (isVideo(bronzeValue)) {
                    processedRow.videoBouts += num;
                } else {
                    processedRow.refBouts += num;
                }
            }
            
            return processedRow;
        }
        
        // Fetch CSV from GitHub
        async function fetchCSVFromGitHub(fileInfo) {
            const url = GITHUB_BASE + fileInfo.file;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                return text;
            } catch (error) {
                console.error(`Error fetching ${fileInfo.file}:`, error);
                return null;
            }
        }
        
        // Load and process all CSV files from GitHub
        async function loadAllData() {
            const loadingStatus = document.getElementById('loadingStatus');
            const progressBar = document.getElementById('progressBar');
            
            let loadedFiles = 0;
            const totalFiles = files.length;
            
            for (const fileInfo of files) {
                loadingStatus.textContent = `Loading ${fileInfo.file}...`;
                progressBar.style.width = `${(loadedFiles / totalFiles) * 100}%`;
                
                const csvText = await fetchCSVFromGitHub(fileInfo);
                if (csvText) {
                    const parsed = Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        delimitersToGuess: [',', '\t', '|', ';']
                    });
                    
                    // Process each row
                    for (const row of parsed.data) {
                        const processedRow = processRow(row, fileInfo.season);
                        if (processedRow) {
                            allData.push(processedRow);
                        }
                    }
                    
                    console.log(`Loaded ${fileInfo.file}: ${parsed.data.length} rows`);
                }
                
                loadedFiles++;
            }
            
            progressBar.style.width = '100%';
            loadingStatus.textContent = 'Processing data...';
            
            // If no data loaded, show error message
            if (allData.length === 0) {
                document.getElementById('allTimeTable').innerHTML = 
                    '<div class="error-message">Unable to load data from GitHub. Please check your internet connection and try again.</div>';
                return;
            }
            
            // Aggregate data
            aggregateData();
            
            // Update UI
            updateStats();
            renderAllTimeTables();
            renderSeasonTabs();
            renderTournamentTabs();
            
            loadingStatus.textContent = 'Complete!';
        }
        
        function aggregateData() {
            // Group by referee
            const grouped = _.groupBy(allData, 'fullName');
            
            aggregatedData = {};
            for (const [name, records] of Object.entries(grouped)) {
                if (!name || name === ', ') continue;
                
                aggregatedData[name] = {
                    name: name,
                    allTime: calculateStats(records),
                    byWeapon: {
                        Foil: calculateStats(records.filter(r => r.weapon === 'Foil')),
                        Epee: calculateStats(records.filter(r => r.weapon === 'Epee')),
                        Saber: calculateStats(records.filter(r => r.weapon === 'Saber'))
                    },
                    bySeason: {},
                    byTournament: {}
                };
                
                // Group by season
                const seasonGroups = _.groupBy(records, 'season');
                for (const [season, seasonRecords] of Object.entries(seasonGroups)) {
                    aggregatedData[name].bySeason[season] = {
                        overall: calculateStats(seasonRecords),
                        byWeapon: {
                            Foil: calculateStats(seasonRecords.filter(r => r.weapon === 'Foil')),
                            Epee: calculateStats(seasonRecords.filter(r => r.weapon === 'Epee')),
                            Saber: calculateStats(seasonRecords.filter(r => r.weapon === 'Saber'))
                        }
                    };
                }
                
                // Group by tournament
                const tournamentGroups = _.groupBy(records, 'tournament');
                for (const [tournament, tournamentRecords] of Object.entries(tournamentGroups)) {
                    aggregatedData[name].byTournament[tournament] = {
                        overall: calculateStats(tournamentRecords),
                        byWeapon: {
                            Foil: calculateStats(tournamentRecords.filter(r => r.weapon === 'Foil')),
                            Epee: calculateStats(tournamentRecords.filter(r => r.weapon === 'Epee')),
                            Saber: calculateStats(tournamentRecords.filter(r => r.weapon === 'Saber'))
                        }
                    };
                }
            }
        }
        
        function calculateStats(records) {
            const stats = {
                totalBouts: 0,
                refBouts: 0,
                videoBouts: 0,
                pools: 0,
                finals: 0,
                bronzeMedals: 0,
                top8: 0,
                events: new Set(),
                tournaments: new Set(),
                seasons: new Set()
            };
            
            for (const record of records) {
                stats.refBouts += record.refBouts || 0;
                stats.videoBouts += record.videoBouts || 0;
                stats.pools += record.pools || 0;
                stats.finals += record.finals || 0;
                stats.bronzeMedals += record.bronzeMedals || 0;
                stats.top8 += record.top8 || 0;
                
                if (record.event) stats.events.add(record.event);
                if (record.tournament) stats.tournaments.add(record.tournament);
                if (record.season) stats.seasons.add(record.season);
            }
            
            stats.totalBouts = stats.refBouts + stats.videoBouts;
            stats.videoPercentage = stats.totalBouts > 0 ? 
                ((stats.videoBouts / stats.totalBouts) * 100).toFixed(1) : '0.0';
            stats.eventCount = stats.events.size;
            stats.tournamentCount = stats.tournaments.size;
            stats.seasonCount = stats.seasons.size;
            
            return stats;
        }
        
        function updateStats() {
            const totalReferees = Object.keys(aggregatedData).length;
            const totalBouts = Object.values(aggregatedData)
                .reduce((sum, ref) => sum + ref.allTime.totalBouts, 0);
            const totalEvents = new Set(allData.map(r => r.event)).size;
            const totalSeasons = new Set(allData.map(r => r.season)).size;
            
            document.getElementById('totalReferees').textContent = totalReferees.toLocaleString();
            document.getElementById('totalBouts').textContent = totalBouts.toLocaleString();
            document.getElementById('totalEvents').textContent = totalEvents.toLocaleString();
            document.getElementById('totalSeasons').textContent = totalSeasons;
        }
        
        function createRefereeTable(data, tableId) {
            if (!data || data.length === 0) {
                return '<div class="no-data">No data available</div>';
            }
            
            let html = `
                <table id="${tableId}">
                    <thead>
                        <tr>
                            <th data-column="rank">#</th>
                            <th data-column="name">Referee Name</th>
                            <th data-column="totalBouts">Total Bouts</th>
                            <th data-column="refBouts">Ref</th>
                            <th data-column="videoBouts">Video Ref</th>
                            <th data-column="videoPercentage">Video %</th>
                            <th data-column="pools">Pools</th>
                            <th data-column="finals">Finals</th>
                            <th data-column="top8">Top 8</th>
                            <th data-column="eventCount">Events</th>
                            <th data-column="tournamentCount">Tournaments</th>
                            <th data-column="seasonCount">Seasons</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach((ref, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${ref.name}</strong></td>
                        <td>${ref.totalBouts || 0}</td>
                        <td>${ref.refBouts || 0}</td>
                        <td>${ref.videoBouts || 0}</td>
                        <td>${ref.videoPercentage || '0.0'}%</td>
                        <td>${ref.pools || 0}</td>
                        <td>${ref.finals || 0}</td>
                        <td>${ref.top8 || 0}</td>
                        <td>${ref.eventCount || 0}</td>
                        <td>${ref.tournamentCount || 0}</td>
                        <td>${ref.seasonCount || 0}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        function renderAllTimeTables() {
            const container = document.getElementById('allTimeTable');
            
            // Get all referees as array
            const referees = Object.entries(aggregatedData).map(([name, data]) => ({
                name,
                ...data.allTime,
                foil: data.byWeapon.Foil,
                epee: data.byWeapon.Epee,
                saber: data.byWeapon.Saber
            }));
            
            // Sort by total bouts
            referees.sort((a, b) => b.totalBouts - a.totalBouts);
            
            // Take top 250
            const top250 = referees.slice(0, 250);
            
            // Create table
            const table = createRefereeTable(top250, 'allTime');
            container.innerHTML = table;
            
            // Add sort functionality
            addSortHandlers('allTime');
        }
        
        function renderSeasonTabs() {
            const seasons = ['2024-25', '2023-24', '2022-23', '2021-22', '2020-21', 
                           '2019-20', '2018-19', '2017-18', '2016-17', '2015-16', '2014-15'];
            
            for (const season of seasons) {
                const container = document.getElementById(season);
                if (!container) continue;
                
                // Create sub-tabs for this season
                let html = `
                    <div class="sub-tabs">
                        <button class="sub-tab active" data-season="${season}" data-subtab="overall">Overall</button>
                        <button class="sub-tab" data-season="${season}" data-subtab="foil">Foil</button>
                        <button class="sub-tab" data-season="${season}" data-subtab="epee">Epee</button>
                        <button class="sub-tab" data-season="${season}" data-subtab="saber">Saber</button>
                    </div>
                    <div class="table-container">
                        <div id="${season}-table"></div>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Render the default overall table
                renderSeasonTable(season, 'overall');
            }
        }
        
        function renderSeasonTable(season, weapon) {
            const container = document.getElementById(`${season}-table`);
            if (!container) return;
            
            // Get referees for this season
            const referees = [];
            for (const [name, data] of Object.entries(aggregatedData)) {
                if (data.bySeason[season]) {
                    const seasonData = weapon === 'overall' ? 
                        data.bySeason[season].overall :
                        data.bySeason[season].byWeapon[weapon.charAt(0).toUpperCase() + weapon.slice(1)];
                    
                    if (seasonData && seasonData.totalBouts > 0) {
                        referees.push({
                            name,
                            ...seasonData
                        });
                    }
                }
            }
            
            // Sort by total bouts
            referees.sort((a, b) => b.totalBouts - a.totalBouts);
            
            // Create table
            const table = createRefereeTable(referees, `${season}-${weapon}`);
            container.innerHTML = table;
            
            // Add sort handlers
            addSortHandlers(`${season}-${weapon}`);
        }
        
        function renderTournamentTabs() {
            const container = document.getElementById('tournaments');
            if (!container) return;
            
            // Get all tournaments
            const tournaments = new Set();
            allData.forEach(r => {
                if (r.tournament && r.tournament !== 'Unknown') {
                    tournaments.add(r.tournament);
                }
            });
            
            // Sort tournaments by calendar order
            const tournamentOrder = [
                'October NAC', 'November NAC', 'December NAC/SJCC', 
                'January NAC', 'Jr Olympics', 'March NAC/SJCC',
                'April NAC', 'May SJCC', 'June NAC/SJCC', 'Summer Nationals'
            ];
            
            const sortedTournaments = Array.from(tournaments)
                .sort((a, b) => {
                    const aIndex = tournamentOrder.indexOf(a);
                    const bIndex = tournamentOrder.indexOf(b);
                    if (aIndex === -1) return 1;
                    if (bIndex === -1) return -1;
                    return aIndex - bIndex;
                });
            
            // Create sub-tabs for tournaments
            let html = '<div class="sub-tabs">';
            sortedTournaments.forEach(tournament => {
                html += `<button class="sub-tab" data-tournament="${tournament}">${tournament}</button>`;
            });
            html += '</div>';
            html += '<div class="table-container"><div id="tournament-table"></div></div>';
            
            container.innerHTML = html;
        }
        
        function renderTournamentTable(tournament) {
            const container = document.getElementById('tournament-table');
            if (!container) return;
            
            // Get referees for this tournament
            const referees = [];
            for (const [name, data] of Object.entries(aggregatedData)) {
                if (data.byTournament[tournament]) {
                    const tournamentData = data.byTournament[tournament].overall;
                    
                    if (tournamentData && tournamentData.totalBouts > 0) {
                        referees.push({
                            name,
                            ...tournamentData
                        });
                    }
                }
            }
            
            // Sort by total bouts
            referees.sort((a, b) => b.totalBouts - a.totalBouts);
            
            // Create table
            const table = createRefereeTable(referees, `tournament-${tournament}`);
            container.innerHTML = table;
            
            // Add sort handlers
            addSortHandlers(`tournament-${tournament}`);
        }
        
        function addSortHandlers(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('th[data-column]');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    sortTable(tableId, column);
                });
            });
        }
        
        function sortTable(tableId, column) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determine sort direction
            let direction = 'desc';
            const currentHeader = table.querySelector(`th[data-column="${column}"]`);
            
            // Clear all sort indicators
            table.querySelectorAll('th').forEach(h => {
                h.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            if (currentSort.column === column && currentSort.direction === 'desc') {
                direction = 'asc';
            }
            
            currentSort = { column, direction };
            
            // Add sort indicator
            currentHeader.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
                const aCell = a.cells[Array.from(a.parentElement.parentElement.querySelectorAll('th'))
                    .findIndex(th => th.dataset.column === column)];
                const bCell = b.cells[Array.from(b.parentElement.parentElement.querySelectorAll('th'))
                    .findIndex(th => th.dataset.column === column)];
                
                if (!aCell || !bCell) return 0;
                
                if (column === 'name') {
                    aValue = aCell.textContent.trim();
                    bValue = bCell.textContent.trim();
                } else if (column === 'videoPercentage') {
                    aValue = parseFloat(aCell.textContent.replace('%', '')) || 0;
                    bValue = parseFloat(bCell.textContent.replace('%', '')) || 0;
                } else {
                    aValue = parseInt(aCell.textContent) || 0;
                    bValue = parseInt(bCell.textContent) || 0;
                }
                
                if (direction === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            // Re-number rows
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
                tbody.appendChild(row);
            });
        }
        
        function renderAllTimeSubtab(subtab) {
            const container = document.getElementById('allTimeTable');
            if (!container) return;
            
            let referees = [];
            
            if (subtab === 'overall') {
                referees = Object.entries(aggregatedData).map(([name, data]) => ({
                    name,
                    ...data.allTime
                }));
            } else if (subtab === 'finals') {
                // Show finals leaders
                referees = Object.entries(aggregatedData).map(([name, data]) => ({
                    name,
                    ...data.allTime
                })).filter(r => r.finals > 0);
                
                // Sort by finals
                referees.sort((a, b) => b.finals - a.finals);
            } else {
                // Weapon-specific
                const weapon = subtab.charAt(0).toUpperCase() + subtab.slice(1);
                referees = Object.entries(aggregatedData).map(([name, data]) => ({
                    name,
                    ...data.byWeapon[weapon]
                })).filter(r => r.totalBouts > 0);
            }
            
            // Sort by total bouts (except for finals which is already sorted)
            if (subtab !== 'finals') {
                referees.sort((a, b) => b.totalBouts - a.totalBouts);
            }
            
            // Take top 250
            const top250 = referees.slice(0, 250);
            
            // Create table
            const table = createRefereeTable(top250, `allTime-${subtab}`);
            container.innerHTML = table;
            
            // Add sort functionality
            addSortHandlers(`allTime-${subtab}`);
        }
        
        function filterAllTimeTable(searchTerm = '') {
            const minBouts = parseInt(document.getElementById('minBoutsAll').value) || 0;
            const activeSubtab = document.querySelector('#all-time .sub-tab.active');
            if (!activeSubtab) return;
            
            const subtab = activeSubtab.dataset.subtab;
            
            let referees = [];
            
            if (subtab === 'overall') {
                referees = Object.entries(aggregatedData).map(([name, data]) => ({
                    name,
                    ...data.allTime
                }));
            } else if (subtab === 'finals') {
                referees = Object.entries(aggregatedData).map(([name, data]) => ({
                    name,
                    ...data.allTime
                })).filter(r => r.finals > 0);
            } else {
                const weapon = subtab.charAt(0).toUpperCase() + subtab.slice(1);
                referees = Object.entries(aggregatedData).map(([name, data]) => ({
                    name,
                    ...data.byWeapon[weapon]
                })).filter(r => r.totalBouts > 0);
            }
            
            // Apply filters
            if (searchTerm) {
                referees = referees.filter(r => 
                    r.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            if (minBouts > 0) {
                referees = referees.filter(r => r.totalBouts >= minBouts);
            }
            
            // Sort
            if (subtab === 'finals') {
                referees.sort((a, b) => b.finals - a.finals);
            } else {
                referees.sort((a, b) => b.totalBouts - a.totalBouts);
            }
            
            // Update table
            const container = document.getElementById('allTimeTable');
            const table = createRefereeTable(referees.slice(0, 250), `allTime-${subtab}`);
            container.innerHTML = table;
            addSortHandlers(`allTime-${subtab}`);
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Load data from GitHub
            await loadAllData();
            
            // Main tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabContent = document.getElementById(tab.dataset.tab);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
            
            // Sub-tab switching for all-time
            document.querySelectorAll('#all-time .sub-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('#all-time .sub-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const subtab = tab.dataset.subtab;
                    renderAllTimeSubtab(subtab);
                });
            });
            
            // Event delegation for dynamically created elements
            document.addEventListener('click', (e) => {
                // Season sub-tabs
                if (e.target.classList.contains('sub-tab') && e.target.dataset.season) {
                    const season = e.target.dataset.season;
                    const subtab = e.target.dataset.subtab;
                    
                    // Update active state
                    e.target.parentElement.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Render the table
                    renderSeasonTable(season, subtab);
                }
                
                // Tournament sub-tabs
                if (e.target.classList.contains('sub-tab') && e.target.dataset.tournament) {
                    const tournament = e.target.dataset.tournament;
                    
                    // Update active state
                    e.target.parentElement.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Render the table
                    renderTournamentTable(tournament);
                }
            });
            
            // Search functionality
            const searchInput = document.getElementById('searchAll');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterAllTimeTable(e.target.value);
                });
            }
            
            const minBoutsInput = document.getElementById('minBoutsAll');
            if (minBoutsInput) {
                minBoutsInput.addEventListener('input', (e) => {
                    const searchTerm = document.getElementById('searchAll').value;
                    filterAllTimeTable(searchTerm);
                });
            }
        });
    </script>
</body>
</html>