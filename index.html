<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USA Fencing Referee Usage Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }
        
        select, input[type="text"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        th.sortable:after {
            content: ' ‚áÖ';
            opacity: 0.5;
            font-size: 0.8em;
        }
        
        th.sorted-asc:after {
            content: ' ‚Üë';
            opacity: 1;
        }
        
        th.sorted-desc:after {
            content: ' ‚Üì';
            opacity: 1;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tbody tr {
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr:nth-child(even) {
            background: #fafbfc;
        }
        
        .weapon-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .weapon-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .weapon-tab:hover {
            color: #667eea;
        }
        
        .weapon-tab.active {
            color: #667eea;
            font-weight: bold;
            border-bottom-color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c00;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #333;
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .subsection-title {
            font-size: 1.3em;
            color: #555;
            margin: 20px 0 15px;
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: scale(1.05);
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding-left: 35px;
        }
        
        .search-box:before {
            content: 'üîç';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .page-btn:hover {
            background: #e0e0e0;
        }
        
        .page-btn.active {
            background: #667eea;
            color: white;
        }
        
        .highlight {
            background: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§∫ USA Fencing Referee Usage Dashboard</h1>
            <p>Comprehensive Analytics for National Tournament Officials</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showTab('seasons')">By Season</button>
            <button class="nav-tab" onclick="showTab('tournaments')">By Tournament</button>
            <button class="nav-tab" onclick="showTab('weapons')">By Weapon</button>
            <button class="nav-tab" onclick="showTab('referees')">Top Referees</button>
            <button class="nav-tab" onclick="showTab('finals')">Finals Leaders</button>
            <button class="nav-tab" onclick="showTab('alltime')">All-Time Stats</button>
        </div>
        
        <div class="content">
            <div id="overview" class="tab-content active">
                <div class="loading">Loading referee data...</div>
            </div>
            
            <div id="seasons" class="tab-content">
                <div class="filters">
                    <div class="filter-group">
                        <label>Select Season:</label>
                        <select id="seasonSelect" onchange="updateSeasonView()">
                            <option value="">All Seasons</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Weapon:</label>
                        <select id="seasonWeaponSelect" onchange="updateSeasonView()">
                            <option value="">All Weapons</option>
                            <option value="Foil">Foil</option>
                            <option value="Epee">Epee</option>
                            <option value="Saber">Saber</option>
                        </select>
                    </div>
                </div>
                <div id="seasonContent"></div>
            </div>
            
            <div id="tournaments" class="tab-content">
                <div class="filters">
                    <div class="filter-group">
                        <label>Select Tournament:</label>
                        <select id="tournamentSelect" onchange="updateTournamentView()">
                            <option value="">Select a tournament...</option>
                        </select>
                    </div>
                </div>
                <div id="tournamentContent"></div>
            </div>
            
            <div id="weapons" class="tab-content">
                <div class="weapon-tabs">
                    <button class="weapon-tab active" onclick="showWeaponTab('all')">All Weapons</button>
                    <button class="weapon-tab" onclick="showWeaponTab('foil')">Foil</button>
                    <button class="weapon-tab" onclick="showWeaponTab('epee')">Epee</button>
                    <button class="weapon-tab" onclick="showWeaponTab('saber')">Saber</button>
                </div>
                <div id="weaponContent"></div>
            </div>
            
            <div id="referees" class="tab-content">
                <div class="filters">
                    <div class="search-box">
                        <input type="text" id="refereeSearch" placeholder="Search referee name..." onkeyup="filterReferees()">
                    </div>
                    <div class="filter-group">
                        <label>Top:</label>
                        <select id="topRefereeCount" onchange="updateRefereeLeaderboard()">
                            <option value="50">Top 50</option>
                            <option value="100">Top 100</option>
                            <option value="200">Top 200</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
                <div id="refereeContent"></div>
            </div>
            
            <div id="finals" class="tab-content">
                <div class="weapon-tabs">
                    <button class="weapon-tab active" onclick="showFinalsWeapon('all')">All Weapons</button>
                    <button class="weapon-tab" onclick="showFinalsWeapon('foil')">Foil</button>
                    <button class="weapon-tab" onclick="showFinalsWeapon('epee')">Epee</button>
                    <button class="weapon-tab" onclick="showFinalsWeapon('saber')">Saber</button>
                </div>
                <div id="finalsContent"></div>
            </div>
            
            <div id="alltime" class="tab-content">
                <div id="alltimeContent"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global data storage
        let allData = [];
        let processedData = {};
        
        // Tournament date mappings
        const tournamentDates = {
            '10/4/2024,10/5/2024,10/6/2024,10/7/2024': 'Oct NAC 2024',
            '11/8/2024,11/9/2024,11/10/2024,11/11/2024': 'Nov NAC 2024',
            '12/6/2024,12/7/2024,12/8/2024': 'Dec SJCC 2024',
            '1/3/2025,1/4/2025,1/5/2025,1/6/2025': 'Jan NAC 2025',
            '2/14/2025,2/15/2025,2/16/2025,2/17/2025': '2025 Junior Olympics',
            '3/6/2025,3/7/2025,3/8/2025,3/9/2025,3/10/2025,3/11/2025': 'March NAC 2025',
            '4/11/2025,4/12/2025,4/13/2025': 'April NAC 2025',
            '5/15/2025,5/16/2025,5/17/2025,5/18/2025,5/19/2025': 'May SJCC 2025'
        };
        
        // Helper functions
        function parseMatchData(value) {
            if (!value || value === null || value === '') return { ref: 0, video: 0 };
            const str = String(value).trim();
            let ref = 0, video = 0;
            const refMatch = str.match(/Ref:\s*(\d+)/i);
            const videoMatch = str.match(/Video:\s*(\d+)/i);
            if (refMatch) ref = parseInt(refMatch[1]) || 0;
            if (videoMatch) video = parseInt(videoMatch[1]) || 0;
            return { ref, video };
        }
        
        function getWeapon(event) {
            if (!event) return 'Unknown';
            const e = event.toUpperCase();
            if (e.includes('MS') || e.includes('WS')) return 'Saber';
            if (e.includes('ME') || e.includes('WE')) return 'Epee';
            if (e.includes('MF') || e.includes('WF')) return 'Foil';
            return 'Unknown';
        }
        
        function getTournamentName(dates) {
            const dateKey = dates.sort().join(',');
            for (const [key, name] of Object.entries(tournamentDates)) {
                if (key.includes(dates[0])) return name;
            }
            return `Tournament ${dates[0]}`;
        }
        
        // Data loading functions
        async function loadAllData() {
            const baseURL = 'https://raw.githubusercontent.com/FirstPointFencing/USA-Fencing-Referee-Usage-Leaderboards/main/';
            
            const filesToLoad = [
                { file: 'Referee_Usage_20142015.csv', season: '2014-2015' },
                { file: 'Referee_Usage_20152016.csv', season: '2015-2016' },
                { file: 'Referee_Usage_20162017.csv', season: '2016-2017' },
                { file: 'Referee_Usage_20172018.csv', season: '2017-2018' },
                { file: 'Referee_Usage_20182019.csv', season: '2018-2019' },
                { file: 'Referee_Usage_20192020.csv', season: '2019-2020' },
                { file: 'Referee_Usage_20202021.csv', season: '2020-2021' },
                { file: 'Referee_Usage_20212022.csv', season: '2021-2022' },
                { file: 'Referee_Usage_20222023_Part1.csv', season: '2022-2023' },
                { file: 'Referee_Usage_20222023_Part2.csv', season: '2022-2023' },
                { file: 'Referee_Usage_20232024_Part1.csv', season: '2023-2024' },
                { file: 'Referee_Usage_20232024_Part2.csv', season: '2023-2024' },
                { file: 'Referee_Usage_20242025_Part1.csv', season: '2024-2025' },
                { file: 'Referee_Usage_20242025_Part2.csv', season: '2024-2025' }
            ];
            
            // Show loading message
            document.getElementById('overview').innerHTML = '<div class="loading">Loading referee data from GitHub repository...</div>';
            
            let loadedCount = 0;
            const totalFiles = filesToLoad.length;
            
            for (const fileInfo of filesToLoad) {
                try {
                    // Fetch from GitHub
                    const response = await fetch(baseURL + fileInfo.file);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    
                    // Update loading progress
                    loadedCount++;
                    document.getElementById('overview').innerHTML = `
                        <div class="loading">
                            Loading referee data from GitHub repository...<br>
                            Progress: ${loadedCount}/${totalFiles} files loaded
                        </div>
                    `;
                    
                    const parsed = Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    
                    parsed.data.forEach(row => {
                        const lastName = row['Last Name'] || row[''];
                        const firstName = row['First Name'];
                        
                        if (!lastName || !row.Date) return;
                        
                        const name = `${lastName}, ${firstName}`.trim();
                        const weapon = getWeapon(row.Event);
                        
                        const matches = {
                            pools: { ref: 0, video: 0 },
                            t512: { ref: 0, video: 0 },
                            t256: { ref: 0, video: 0 },
                            t128: { ref: 0, video: 0 },
                            t64: { ref: 0, video: 0 },
                            t32: { ref: 0, video: 0 },
                            t16: { ref: 0, video: 0 },
                            t8: { ref: 0, video: 0 },
                            semis: { ref: 0, video: 0 },
                            bronze: { ref: 0, video: 0 },
                            finals: { ref: 0, video: 0 }
                        };
                        
                        // Handle multiple Pools columns
                        let poolsProcessed = 0;
                        Object.keys(row).forEach(key => {
                            if (key === 'Pools' && row[key] !== null && row[key] !== '') {
                                const data = parseMatchData(row[key]);
                                matches.pools.ref += data.ref;
                                matches.pools.video += data.video;
                                poolsProcessed++;
                            }
                        });
                        
                        // Handle multiple Table of 128 columns
                        Object.keys(row).forEach(key => {
                            if ((key === 'Table of 128' || key.trim() === 'Table of 128') && row[key]) {
                                const data = parseMatchData(row[key]);
                                matches.t128.ref += data.ref;
                                matches.t128.video += data.video;
                            }
                        });
                        
                        // Parse other columns
                        matches.t512 = parseMatchData(row['Table of 512']);
                        matches.t256 = parseMatchData(row['Table of 256']);
                        matches.t64 = parseMatchData(row['Table of 64']);
                        matches.t32 = parseMatchData(row['Table of 32']);
                        matches.t16 = parseMatchData(row['Table of 16']);
                        matches.t8 = parseMatchData(row['Table of 8']);
                        matches.semis = parseMatchData(row['Semi-Finals']);
                        matches.bronze = parseMatchData(row['Bronze Medal Matches']);
                        matches.finals = parseMatchData(row['Finals']);
                        
                        allData.push({
                            season: fileInfo.season,
                            date: row.Date,
                            name: name,
                            event: row.Event,
                            weapon: weapon,
                            matches: matches
                        });
                    });
                    
                    console.log(`Loaded ${fileInfo.file}: ${parsed.data.length} rows`);
                    
                } catch (e) {
                    console.error(`Error loading ${fileInfo.file}:`, e);
                    
                    // Show error but continue loading other files
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = `Failed to load ${fileInfo.file}: ${e.message}`;
                    document.getElementById('overview').appendChild(errorDiv);
                }
            }
            
            if (allData.length === 0) {
                document.getElementById('overview').innerHTML = `
                    <div class="error">
                        Failed to load data from GitHub repository. 
                        Please check your internet connection and try again.
                        <br><br>
                        Repository: <a href="https://github.com/FirstPointFencing/USA-Fencing-Referee-Usage-Leaderboards" target="_blank">
                            https://github.com/FirstPointFencing/USA-Fencing-Referee-Usage-Leaderboards
                        </a>
                    </div>
                `;
                return;
            }
            
            console.log(`Total data loaded: ${allData.length} rows`);
            processData();
            updateUI();
        }
        
        function processData() {
            // Group data by seasons
            processedData.seasons = {};
            processedData.tournaments = {};
            processedData.referees = {};
            processedData.weapons = { Foil: {}, Epee: {}, Saber: {} };
            
            allData.forEach(row => {
                // Season processing
                if (!processedData.seasons[row.season]) {
                    processedData.seasons[row.season] = {
                        referees: {},
                        weapons: { Foil: {}, Epee: {}, Saber: {} },
                        tournaments: new Set(),
                        totalBouts: 0
                    };
                }
                
                // Tournament processing
                const tournamentKey = row.date;
                if (!processedData.tournaments[tournamentKey]) {
                    processedData.tournaments[tournamentKey] = {
                        season: row.season,
                        referees: {},
                        weapons: { Foil: {}, Epee: {}, Saber: {} },
                        events: new Set(),
                        totalBouts: 0
                    };
                }
                
                // Calculate totals for this row
                let refTotal = 0, videoTotal = 0;
                Object.values(row.matches).forEach(m => {
                    refTotal += m.ref;
                    videoTotal += m.video;
                });
                
                // Update referee stats
                if (!processedData.referees[row.name]) {
                    processedData.referees[row.name] = {
                        totalRef: 0,
                        totalVideo: 0,
                        finals: 0,
                        finalsVideo: 0,
                        top8: 0,
                        pools: 0,
                        seasons: new Set(),
                        tournaments: new Set(),
                        weapons: { Foil: 0, Epee: 0, Saber: 0 }
                    };
                }
                
                const ref = processedData.referees[row.name];
                ref.totalRef += refTotal;
                ref.totalVideo += videoTotal;
                ref.finals += row.matches.finals.ref;
                ref.finalsVideo += row.matches.finals.video;
                ref.top8 += row.matches.t8.ref + row.matches.semis.ref;
                ref.pools += row.matches.pools.ref;
                ref.seasons.add(row.season);
                ref.tournaments.add(`${row.season}-${row.date}`);
                if (row.weapon !== 'Unknown') {
                    ref.weapons[row.weapon] += refTotal + videoTotal;
                }
                
                // Update season referee stats
                const seasonRef = processedData.seasons[row.season].referees;
                if (!seasonRef[row.name]) {
                    seasonRef[row.name] = {
                        totalRef: 0,
                        totalVideo: 0,
                        finals: 0,
                        finalsVideo: 0,
                        top8: 0,
                        pools: 0,
                        events: new Set(),
                        tournaments: new Set()
                    };
                }
                seasonRef[row.name].totalRef += refTotal;
                seasonRef[row.name].totalVideo += videoTotal;
                seasonRef[row.name].finals += row.matches.finals.ref;
                seasonRef[row.name].finalsVideo += row.matches.finals.video;
                seasonRef[row.name].top8 += row.matches.t8.ref + row.matches.semis.ref;
                seasonRef[row.name].pools += row.matches.pools.ref;
                seasonRef[row.name].events.add(row.event);
                seasonRef[row.name].tournaments.add(row.date);
                
                // Update tournament referee stats
                const tournRef = processedData.tournaments[tournamentKey].referees;
                if (!tournRef[row.name]) {
                    tournRef[row.name] = {
                        totalRef: 0,
                        totalVideo: 0,
                        finals: 0,
                        finalsVideo: 0,
                        top8: 0,
                        pools: 0,
                        events: new Set()
                    };
                }
                tournRef[row.name].totalRef += refTotal;
                tournRef[row.name].totalVideo += videoTotal;
                tournRef[row.name].finals += row.matches.finals.ref;
                tournRef[row.name].finalsVideo += row.matches.finals.video;
                tournRef[row.name].top8 += row.matches.t8.ref + row.matches.semis.ref;
                tournRef[row.name].pools += row.matches.pools.ref;
                tournRef[row.name].events.add(row.event);
                
                // Update totals
                processedData.seasons[row.season].totalBouts += refTotal + videoTotal;
                processedData.tournaments[tournamentKey].totalBouts += refTotal + videoTotal;
                processedData.seasons[row.season].tournaments.add(row.date);
                processedData.tournaments[tournamentKey].events.add(row.event);
            });
        }
        
        function updateUI() {
            // Update overview
            updateOverview();
            
            // Populate dropdowns
            populateDropdowns();
            
            // Update initial views
            updateSeasonView();
            updateRefereeLeaderboard();
            updateWeaponStats();
            updateFinalsLeaderboard();
            updateAllTimeStats();
        }
        
        function updateOverview() {
            const overview = document.getElementById('overview');
            
            const totalReferees = Object.keys(processedData.referees).length;
            const totalSeasons = Object.keys(processedData.seasons).length;
            const totalTournaments = Object.keys(processedData.tournaments).length;
            const totalBouts = Object.values(processedData.referees).reduce((sum, ref) => 
                sum + ref.totalRef + ref.totalVideo, 0);
            
            overview.innerHTML = `
                <h2 class="section-title">üìä Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Referees</h3>
                        <div class="value">${totalReferees.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Seasons Tracked</h3>
                        <div class="value">${totalSeasons}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Tournaments</h3>
                        <div class="value">${totalTournaments}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Bouts Officiated</h3>
                        <div class="value">${totalBouts.toLocaleString()}</div>
                    </div>
                </div>
                
                <h3 class="subsection-title">Recent Activity</h3>
                ${generateQuickStatsTable()}
            `;
        }
        
        function generateQuickStatsTable() {
            const recentSeason = '2024-2025';
            const seasonData = processedData.seasons[recentSeason];
            if (!seasonData) return '<p>No recent season data available</p>';
            
            const topRefs = Object.entries(seasonData.referees)
                .map(([name, data]) => ({
                    name,
                    total: data.totalRef + data.totalVideo,
                    ref: data.totalRef,
                    video: data.totalVideo,
                    videoPercent: data.totalRef > 0 ? 
                        ((data.totalVideo / (data.totalRef + data.totalVideo)) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            return `
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Referee</th>
                            <th>Total Matches</th>
                            <th>As Referee</th>
                            <th>As Video</th>
                            <th>Video %</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topRefs.map((ref, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${ref.name}</td>
                                <td>${ref.total}</td>
                                <td>${ref.ref}</td>
                                <td>${ref.video}</td>
                                <td>${ref.videoPercent}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function populateDropdowns() {
            // Season dropdown
            const seasonSelect = document.getElementById('seasonSelect');
            const seasons = Object.keys(processedData.seasons).sort().reverse();
            seasonSelect.innerHTML = '<option value="">All Seasons</option>';
            seasons.forEach(season => {
                seasonSelect.innerHTML += `<option value="${season}">${season}</option>`;
            });
            
            // Tournament dropdown
            const tournamentSelect = document.getElementById('tournamentSelect');
            const tournaments = Object.entries(processedData.tournaments)
                .map(([date, data]) => ({
                    date,
                    season: data.season,
                    name: getTournamentName([date])
                }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tournamentSelect.innerHTML = '<option value="">Select a tournament...</option>';
            let currentSeason = '';
            tournaments.forEach(t => {
                if (t.season !== currentSeason) {
                    if (currentSeason) tournamentSelect.innerHTML += '</optgroup>';
                    tournamentSelect.innerHTML += `<optgroup label="${t.season}">`;
                    currentSeason = t.season;
                }
                tournamentSelect.innerHTML += `<option value="${t.date}">${t.name} (${t.date})</option>`;
            });
            if (currentSeason) tournamentSelect.innerHTML += '</optgroup>';
        }
        
        function updateSeasonView() {
            const season = document.getElementById('seasonSelect').value;
            const weapon = document.getElementById('seasonWeaponSelect').value;
            const content = document.getElementById('seasonContent');
            
            if (!season) {
                // Show all seasons summary
                content.innerHTML = generateAllSeasonsSummary();
            } else {
                // Show specific season
                content.innerHTML = generateSeasonDetails(season, weapon);
            }
        }
        
        function generateAllSeasonsSummary() {
            const seasonStats = Object.entries(processedData.seasons)
                .map(([season, data]) => ({
                    season,
                    referees: Object.keys(data.referees).length,
                    tournaments: data.tournaments.size,
                    bouts: data.totalBouts
                }))
                .sort((a, b) => b.season.localeCompare(a.season));
            
            return `
                <h2 class="section-title">All Seasons Summary</h2>
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(this, 0)">Season</th>
                            <th class="sortable" onclick="sortTable(this, 1)">Referees</th>
                            <th class="sortable" onclick="sortTable(this, 2)">Tournaments</th>
                            <th class="sortable" onclick="sortTable(this, 3)">Total Bouts</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${seasonStats.map(s => `
                            <tr>
                                <td>${s.season}</td>
                                <td>${s.referees}</td>
                                <td>${s.tournaments}</td>
                                <td>${s.bouts.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function generateSeasonDetails(season, weapon) {
            const data = processedData.seasons[season];
            if (!data) return '<p>No data for selected season</p>';
            
            let referees = Object.entries(data.referees)
                .map(([name, stats]) => ({
                    name,
                    totalRef: stats.totalRef,
                    totalVideo: stats.totalVideo,
                    total: stats.totalRef + stats.totalVideo,
                    videoPercent: stats.totalRef > 0 ? 
                        ((stats.totalVideo / (stats.totalRef + stats.totalVideo)) * 100).toFixed(1) : 0,
                    finals: stats.finals,
                    finalsVideo: stats.finalsVideo,
                    top8: stats.top8,
                    pools: stats.pools,
                    events: stats.events.size,
                    tournaments: stats.tournaments.size
                }));
            
            if (weapon) {
                // Filter by weapon - need to reprocess for weapon-specific stats
                referees = referees.filter(ref => {
                    const refData = allData.filter(d => 
                        d.season === season && 
                        d.name === ref.name && 
                        d.weapon === weapon
                    );
                    return refData.length > 0;
                });
            }
            
            referees.sort((a, b) => b.total - a.total);
            
            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Referees</h3>
                        <div class="value">${referees.length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Tournaments</h3>
                        <div class="value">${data.tournaments.size}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Bouts</h3>
                        <div class="value">${data.totalBouts.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Finals Officiated</h3>
                        <div class="value">${referees.reduce((sum, r) => sum + r.finals + r.finalsVideo, 0)}</div>
                    </div>
                </div>
            `;
            
            return `
                <h2 class="section-title">${season} Season${weapon ? ' - ' + weapon : ''}</h2>
                ${stats}
                <h3 class="subsection-title">Referee Statistics</h3>
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(this, 0)">Rank</th>
                            <th class="sortable" onclick="sortTable(this, 1)">Referee</th>
                            <th class="sortable" onclick="sortTable(this, 2)">Ref Matches</th>
                            <th class="sortable" onclick="sortTable(this, 3)">Video Matches</th>
                            <th class="sortable" onclick="sortTable(this, 4)">Total</th>
                            <th class="sortable" onclick="sortTable(this, 5)">Video %</th>
                            <th class="sortable" onclick="sortTable(this, 6)">Finals (Ref)</th>
                            <th class="sortable" onclick="sortTable(this, 7)">Finals (Video)</th>
                            <th class="sortable" onclick="sortTable(this, 8)">Top 8</th>
                            <th class="sortable" onclick="sortTable(this, 9)">Pools</th>
                            <th class="sortable" onclick="sortTable(this, 10)">Events</th>
                            <th class="sortable" onclick="sortTable(this, 11)">Tournaments</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${referees.map((ref, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${ref.name}</td>
                                <td>${ref.totalRef}</td>
                                <td>${ref.totalVideo}</td>
                                <td><strong>${ref.total}</strong></td>
                                <td>${ref.videoPercent}%</td>
                                <td>${ref.finals}</td>
                                <td>${ref.finalsVideo}</td>
                                <td>${ref.top8}</td>
                                <td>${ref.pools}</td>
                                <td>${ref.events}</td>
                                <td>${ref.tournaments}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function updateTournamentView() {
            const tournamentDate = document.getElementById('tournamentSelect').value;
            const content = document.getElementById('tournamentContent');
            
            if (!tournamentDate) {
                content.innerHTML = '<p>Please select a tournament</p>';
                return;
            }
            
            const data = processedData.tournaments[tournamentDate];
            if (!data) {
                content.innerHTML = '<p>No data for selected tournament</p>';
                return;
            }
            
            const referees = Object.entries(data.referees)
                .map(([name, stats]) => ({
                    name,
                    totalRef: stats.totalRef,
                    totalVideo: stats.totalVideo,
                    total: stats.totalRef + stats.totalVideo,
                    videoPercent: stats.totalRef > 0 ? 
                        ((stats.totalVideo / (stats.totalRef + stats.totalVideo)) * 100).toFixed(1) : 0,
                    finals: stats.finals,
                    finalsVideo: stats.finalsVideo,
                    top8: stats.top8,
                    pools: stats.pools,
                    events: stats.events.size
                }))
                .sort((a, b) => b.total - a.total);
            
            // Generate weapon-specific tables
            const weapons = ['Foil', 'Epee', 'Saber'];
            const weaponTables = weapons.map(weapon => {
                const weaponRefs = allData
                    .filter(d => d.date === tournamentDate && d.weapon === weapon)
                    .reduce((acc, d) => {
                        if (!acc[d.name]) {
                            acc[d.name] = {
                                name: d.name,
                                totalRef: 0,
                                totalVideo: 0,
                                finals: 0,
                                finalsVideo: 0,
                                pools: 0,
                                events: new Set()
                            };
                        }
                        
                        Object.values(d.matches).forEach(m => {
                            acc[d.name].totalRef += m.ref;
                            acc[d.name].totalVideo += m.video;
                        });
                        acc[d.name].finals += d.matches.finals.ref;
                        acc[d.name].finalsVideo += d.matches.finals.video;
                        acc[d.name].pools += d.matches.pools.ref;
                        acc[d.name].events.add(d.event);
                        
                        return acc;
                    }, {});
                
                const weaponRefArray = Object.values(weaponRefs)
                    .map(r => ({
                        ...r,
                        total: r.totalRef + r.totalVideo,
                        videoPercent: r.totalRef > 0 ? 
                            ((r.totalVideo / (r.totalRef + r.totalVideo)) * 100).toFixed(1) : 0,
                        events: r.events.size
                    }))
                    .sort((a, b) => b.total - a.total);
                
                if (weaponRefArray.length === 0) return '';
                
                return `
                    <h3 class="subsection-title">${weapon} Referees</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Referee</th>
                                <th>Ref Matches</th>
                                <th>Video Matches</th>
                                <th>Total</th>
                                <th>Video %</th>
                                <th>Finals</th>
                                <th>Pools</th>
                                <th>Events</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${weaponRefArray.map((ref, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${ref.name}</td>
                                    <td>${ref.totalRef}</td>
                                    <td>${ref.totalVideo}</td>
                                    <td><strong>${ref.total}</strong></td>
                                    <td>${ref.videoPercent}%</td>
                                    <td>${ref.finals + ref.finalsVideo}</td>
                                    <td>${ref.pools}</td>
                                    <td>${ref.events}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }).join('');
            
            content.innerHTML = `
                <h2 class="section-title">${getTournamentName([tournamentDate])} - ${data.season}</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Referees</h3>
                        <div class="value">${referees.length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Events</h3>
                        <div class="value">${data.events.size}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Bouts</h3>
                        <div class="value">${data.totalBouts.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Finals Officiated</h3>
                        <div class="value">${referees.reduce((sum, r) => sum + r.finals + r.finalsVideo, 0)}</div>
                    </div>
                </div>
                
                <h3 class="subsection-title">All Weapons - Aggregate</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Referee</th>
                            <th>Ref Matches</th>
                            <th>Video Matches</th>
                            <th>Total</th>
                            <th>Video %</th>
                            <th>Finals (Ref)</th>
                            <th>Finals (Video)</th>
                            <th>Top 8</th>
                            <th>Pools</th>
                            <th>Events</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${referees.slice(0, 50).map((ref, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${ref.name}</td>
                                <td>${ref.totalRef}</td>
                                <td>${ref.totalVideo}</td>
                                <td><strong>${ref.total}</strong></td>
                                <td>${ref.videoPercent}%</td>
                                <td>${ref.finals}</td>
                                <td>${ref.finalsVideo}</td>
                                <td>${ref.top8}</td>
                                <td>${ref.pools}</td>
                                <td>${ref.events}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                ${weaponTables}
            `;
        }
        
        function updateRefereeLeaderboard() {
            const topCount = document.getElementById('topRefereeCount').value;
            const searchTerm = document.getElementById('refereeSearch').value.toLowerCase();
            const content = document.getElementById('refereeContent');
            
            let referees = Object.entries(processedData.referees)
                .map(([name, data]) => ({
                    name,
                    totalRef: data.totalRef,
                    totalVideo: data.totalVideo,
                    total: data.totalRef + data.totalVideo,
                    videoPercent: data.totalRef > 0 ? 
                        ((data.totalVideo / (data.totalRef + data.totalVideo)) * 100).toFixed(1) : 0,
                    finals: data.finals + data.finalsVideo,
                    seasons: data.seasons.size,
                    tournaments: data.tournaments.size,
                    foil: data.weapons.Foil,
                    epee: data.weapons.Epee,
                    saber: data.weapons.Saber
                }));
            
            if (searchTerm) {
                referees = referees.filter(r => r.name.toLowerCase().includes(searchTerm));
            }
            
            referees.sort((a, b) => b.total - a.total);
            
            if (topCount !== 'all') {
                referees = referees.slice(0, parseInt(topCount));
            }
            
            content.innerHTML = `
                <h2 class="section-title">Top Referees - All Time</h2>
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(this, 0)">Rank</th>
                            <th class="sortable" onclick="sortTable(this, 1)">Referee</th>
                            <th class="sortable" onclick="sortTable(this, 2)">Total Matches</th>
                            <th class="sortable" onclick="sortTable(this, 3)">As Referee</th>
                            <th class="sortable" onclick="sortTable(this, 4)">As Video</th>
                            <th class="sortable" onclick="sortTable(this, 5)">Video %</th>
                            <th class="sortable" onclick="sortTable(this, 6)">Finals</th>
                            <th class="sortable" onclick="sortTable(this, 7)">Seasons</th>
                            <th class="sortable" onclick="sortTable(this, 8)">Tournaments</th>
                            <th class="sortable" onclick="sortTable(this, 9)">Foil</th>
                            <th class="sortable" onclick="sortTable(this, 10)">Epee</th>
                            <th class="sortable" onclick="sortTable(this, 11)">Saber</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${referees.map((ref, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${ref.name}</td>
                                <td><strong>${ref.total}</strong></td>
                                <td>${ref.totalRef}</td>
                                <td>${ref.totalVideo}</td>
                                <td>${ref.videoPercent}%</td>
                                <td>${ref.finals}</td>
                                <td>${ref.seasons}</td>
                                <td>${ref.tournaments}</td>
                                <td>${ref.foil}</td>
                                <td>${ref.epee}</td>
                                <td>${ref.saber}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function updateWeaponStats() {
            showWeaponTab('all');
        }
        
        function showWeaponTab(weapon) {
            const content = document.getElementById('weaponContent');
            const tabs = document.querySelectorAll('.weapon-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(weapon.toLowerCase())) {
                    tab.classList.add('active');
                }
            });
            
            if (weapon === 'all') {
                content.innerHTML = generateAllWeaponsStats();
            } else {
                content.innerHTML = generateWeaponSpecificStats(weapon);
            }
        }
        
        function generateAllWeaponsStats() {
            const weaponStats = ['Foil', 'Epee', 'Saber'].map(weapon => {
                const refs = Object.entries(processedData.referees)
                    .filter(([_, data]) => data.weapons[weapon] > 0)
                    .map(([name, data]) => ({
                        name,
                        total: data.weapons[weapon]
                    }))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 10);
                
                return { weapon, refs };
            });
            
            return `
                <h2 class="section-title">All Weapons Overview</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                    ${weaponStats.map(ws => `
                        <div>
                            <h3 class="subsection-title">${ws.weapon} - Top 10</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Referee</th>
                                        <th>Total Matches</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ws.refs.map((ref, i) => `
                                        <tr>
                                            <td>${i + 1}</td>
                                            <td>${ref.name}</td>
                                            <td>${ref.total}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function generateWeaponSpecificStats(weapon) {
            const weaponName = weapon.charAt(0).toUpperCase() + weapon.slice(1);
            
            const referees = allData
                .filter(d => d.weapon === weaponName)
                .reduce((acc, d) => {
                    if (!acc[d.name]) {
                        acc[d.name] = {
                            name: d.name,
                            totalRef: 0,
                            totalVideo: 0,
                            finals: 0,
                            finalsVideo: 0,
                            seasons: new Set(),
                            tournaments: new Set()
                        };
                    }
                    
                    Object.values(d.matches).forEach(m => {
                        acc[d.name].totalRef += m.ref;
                        acc[d.name].totalVideo += m.video;
                    });
                    acc[d.name].finals += d.matches.finals.ref;
                    acc[d.name].finalsVideo += d.matches.finals.video;
                    acc[d.name].seasons.add(d.season);
                    acc[d.name].tournaments.add(`${d.season}-${d.date}`);
                    
                    return acc;
                }, {});
            
            const refArray = Object.values(referees)
                .map(r => ({
                    ...r,
                    total: r.totalRef + r.totalVideo,
                    videoPercent: r.totalRef > 0 ? 
                        ((r.totalVideo / (r.totalRef + r.totalVideo)) * 100).toFixed(1) : 0,
                    seasons: r.seasons.size,
                    tournaments: r.tournaments.size
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 50);
            
            return `
                <h2 class="section-title">${weaponName} Specialists - Top 50</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Referee</th>
                            <th>Total Matches</th>
                            <th>As Referee</th>
                            <th>As Video</th>
                            <th>Video %</th>
                            <th>Finals</th>
                            <th>Seasons</th>
                            <th>Tournaments</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${refArray.map((ref, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${ref.name}</td>
                                <td><strong>${ref.total}</strong></td>
                                <td>${ref.totalRef}</td>
                                <td>${ref.totalVideo}</td>
                                <td>${ref.videoPercent}%</td>
                                <td>${ref.finals + ref.finalsVideo}</td>
                                <td>${ref.seasons}</td>
                                <td>${ref.tournaments}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function updateFinalsLeaderboard() {
            showFinalsWeapon('all');
        }
        
        function showFinalsWeapon(weapon) {
            const content = document.getElementById('finalsContent');
            const tabs = document.querySelectorAll('#finals .weapon-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(weapon.toLowerCase())) {
                    tab.classList.add('active');
                }
            });
            
            let finalsData = [];
            
            if (weapon === 'all') {
                finalsData = Object.entries(processedData.referees)
                    .map(([name, data]) => ({
                        name,
                        finals: data.finals,
                        finalsVideo: data.finalsVideo,
                        total: data.finals + data.finalsVideo
                    }))
                    .filter(r => r.total > 0)
                    .sort((a, b) => b.total - a.total);
            } else {
                const weaponName = weapon.charAt(0).toUpperCase() + weapon.slice(1);
                const weaponFinals = allData
                    .filter(d => d.weapon === weaponName && 
                           (d.matches.finals.ref > 0 || d.matches.finals.video > 0))
                    .reduce((acc, d) => {
                        if (!acc[d.name]) {
                            acc[d.name] = { name: d.name, finals: 0, finalsVideo: 0 };
                        }
                        acc[d.name].finals += d.matches.finals.ref;
                        acc[d.name].finalsVideo += d.matches.finals.video;
                        return acc;
                    }, {});
                
                finalsData = Object.values(weaponFinals)
                    .map(r => ({
                        ...r,
                        total: r.finals + r.finalsVideo
                    }))
                    .sort((a, b) => b.total - a.total);
            }
            
            content.innerHTML = `
                <h2 class="section-title">Finals Leaderboard - ${weapon === 'all' ? 'All Weapons' : weapon.charAt(0).toUpperCase() + weapon.slice(1)}</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Referee</th>
                            <th>Finals as Referee</th>
                            <th>Finals as Video</th>
                            <th>Total Finals</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${finalsData.slice(0, 50).map((ref, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${ref.name}</td>
                                <td>${ref.finals}</td>
                                <td>${ref.finalsVideo}</td>
                                <td><strong>${ref.total}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function updateAllTimeStats() {
            const content = document.getElementById('alltimeContent');
            
            const totalBouts = allData.reduce((sum, d) => {
                let total = 0;
                Object.values(d.matches).forEach(m => {
                    total += m.ref + m.video;
                });
                return sum + total;
            }, 0);
            
            const totalFinals = allData.reduce((sum, d) => 
                sum + d.matches.finals.ref + d.matches.finals.video, 0);
            
            const mostActive = Object.entries(processedData.referees)
                .map(([name, data]) => ({
                    name,
                    total: data.totalRef + data.totalVideo,
                    seasons: data.seasons.size,
                    tournaments: data.tournaments.size
                }))
                .sort((a, b) => b.total - a.total)[0];
            
            content.innerHTML = `
                <h2 class="section-title">All-Time Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Bouts Officiated</h3>
                        <div class="value">${totalBouts.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Finals</h3>
                        <div class="value">${totalFinals.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Most Active Referee</h3>
                        <div class="value" style="font-size: 1.2em;">${mostActive.name}</div>
                        <p style="margin-top: 5px; font-size: 0.9em;">${mostActive.total} matches</p>
                    </div>
                    <div class="stat-card">
                        <h3>Data Span</h3>
                        <div class="value" style="font-size: 1.5em;">2014-2025</div>
                        <p style="margin-top: 5px; font-size: 0.9em;">10 Seasons</p>
                    </div>
                </div>
                
                <h3 class="subsection-title">Historical Trends</h3>
                ${generateHistoricalTrends()}
            `;
        }
        
        function generateHistoricalTrends() {
            const seasonTrends = Object.entries(processedData.seasons)
                .map(([season, data]) => ({
                    season,
                    bouts: data.totalBouts,
                    referees: Object.keys(data.referees).length
                }))
                .sort((a, b) => a.season.localeCompare(b.season));
            
            return `
                <table>
                    <thead>
                        <tr>
                            <th>Season</th>
                            <th>Total Bouts</th>
                            <th>Active Referees</th>
                            <th>Avg Bouts/Referee</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${seasonTrends.map(s => `
                            <tr>
                                <td>${s.season}</td>
                                <td>${s.bouts.toLocaleString()}</td>
                                <td>${s.referees}</td>
                                <td>${Math.round(s.bouts / s.referees)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Utility functions
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                    tab.classList.add('active');
                }
            });
            
            contents.forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
        }
        
        function sortTable(th, columnIndex) {
            const table = th.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            const isAscending = th.classList.contains('sorted-asc');
            
            // Remove all sorting classes
            table.querySelectorAll('th').forEach(header => {
                header.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.replace(/[,$%]/g, '');
                const bValue = b.cells[columnIndex].textContent.replace(/[,$%]/g, '');
                
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAscending ? aNum - bNum : bNum - aNum;
                }
                
                return isAscending ? 
                    aValue.localeCompare(bValue) : 
                    bValue.localeCompare(aValue);
            });
            
            // Update sort indicator
            th.classList.add(isAscending ? 'sorted-desc' : 'sorted-asc');
            
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function filterReferees() {
            updateRefereeLeaderboard();
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });