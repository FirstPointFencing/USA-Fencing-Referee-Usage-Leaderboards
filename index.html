<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USA Fencing Referee Usage Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            font-size: 1.2em;
            color: #b3c5ff;
        }
        
        .controls {
            background: #1e1e3f;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #3949ab;
            border-radius: 25px;
            background: #0a0e27;
            color: #e0e0e0;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #5c6bc0;
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.2);
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            border-bottom: 2px solid #3949ab;
        }
        
        .tab {
            padding: 10px 20px;
            background: #1e1e3f;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .tab:hover {
            background: #2a2a4f;
        }
        
        .tab.active {
            background: #3949ab;
            color: #fff;
            transform: translateY(-2px);
        }
        
        .subtabs {
            display: none;
            gap: 5px;
            margin-bottom: 15px;
            padding: 10px;
            background: #1e1e3f;
            border-radius: 8px;
        }
        
        .subtabs.active {
            display: flex;
            flex-wrap: wrap;
        }
        
        .subtab {
            padding: 8px 16px;
            background: #2a2a4f;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        
        .subtab:hover {
            background: #3a3a5f;
        }
        
        .subtab.active {
            background: #5c6bc0;
            color: #fff;
        }
        
        .table-container {
            background: #1e1e3f;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #2a2a4f;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s ease;
        }
        
        th:hover {
            background: #3a3a5f;
        }
        
        th.sortable:after {
            content: " ⇅";
            opacity: 0.5;
            font-size: 0.8em;
        }
        
        th.sorted-asc:after {
            content: " ↑";
            opacity: 1;
        }
        
        th.sorted-desc:after {
            content: " ↓";
            opacity: 1;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #2a2a4f;
        }
        
        tr:hover {
            background: #252550;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }
        
        .stats-card {
            background: #2a2a4f;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: #1e1e3f;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #5c6bc0;
        }
        
        .stat-label {
            color: #9e9e9e;
            font-size: 0.9em;
        }
        
        .highlight {
            background: #ffeb3b20;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>USA Fencing Referee Usage Dashboard</h1>
            <p class="subtitle">Comprehensive Analysis of National Level Referee Performance</p>
        </header>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search for referee by name...">
            </div>
            <div id="fileInputContainer" style="display: none;">
                <input type="file" id="fileInput" multiple accept=".csv" style="display: none;">
                <button onclick="document.getElementById('fileInput').click()" style="padding: 10px 20px; background: #3949ab; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Load CSV Files
                </button>
            </div>
        </div>
        
        <div class="tabs" id="mainTabs"></div>
        <div class="subtabs" id="subtabs"></div>
        
        <div id="statsContainer"></div>
        <div class="table-container">
            <div id="tableContent" class="loading">Loading referee data...</div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Global data storage
        let allData = [];
        let currentView = 'all-time';
        let currentSubView = 'all';
        let sortColumn = null;
        let sortDirection = 'desc';
        
        // GitHub repository base URL
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/FirstPointFencing/USA-Fencing-Referee-Usage-Leaderboards/main/';
        
        // Season definitions
        const seasons = [
            { id: '2014-2015', label: '2014-2015', files: ['Referee_Usage_20142015.csv'] },
            { id: '2015-2016', label: '2015-2016', files: ['Referee_Usage_20152016.csv'] },
            { id: '2016-2017', label: '2016-2017', files: ['Referee_Usage_20162017.csv'] },
            { id: '2017-2018', label: '2017-2018', files: ['Referee_Usage_20172018.csv'] },
            { id: '2018-2019', label: '2018-2019', files: ['Referee_Usage_20182019.csv'] },
            { id: '2019-2020', label: '2019-2020', files: ['Referee_Usage_20192020.csv'] },
            { id: '2020-2021', label: '2020-2021', files: ['Referee_Usage_20202021.csv'] },
            { id: '2021-2022', label: '2021-2022', files: ['Referee_Usage_20212022.csv'] },
            { id: '2022-2023', label: '2022-2023', files: ['Referee_Usage_20222023_Part1.csv', 'Referee_Usage_20222023_Part2.csv'] },
            { id: '2023-2024', label: '2023-2024', files: ['Referee_Usage_20232024_Part1.csv', 'Referee_Usage_20232024_Part2.csv'] },
            { id: '2024-2025', label: '2024-2025', files: ['Referee_Usage_20242025.csv', 'Referee_Usage_20242025_Part1.csv', 'Referee_Usage_20242025_Part2.csv'] }
        ];
        
        // Tournament definitions
        const tournaments = [
            { id: 'october-nac', label: 'October NAC', months: [10] },
            { id: 'november-nac', label: 'November NAC', months: [11] },
            { id: 'december-nac', label: 'December NAC/SJCC', months: [12] },
            { id: 'january-nac', label: 'January NAC', months: [1] },
            { id: 'jr-olympics', label: 'Jr Olympics', months: [2] },
            { id: 'march-nac', label: 'March NAC/SJCC', months: [3] },
            { id: 'april-nac', label: 'April NAC', months: [4] },
            { id: 'may-sjcc', label: 'May SJCC', months: [5] },
            { id: 'june-nac', label: 'June NAC/SJCC', months: [6] },
            { id: 'summer-nationals', label: 'Summer Nationals', dateRange: { start: '06/27', end: '07/13' } }
        ];
        
        // Weapon categories
        const weapons = {
            'all': 'All Weapons',
            'foil': 'Foil',
            'epee': 'Epee',
            'saber': 'Saber'
        };
        
        // Initialize the dashboard
        async function init() {
            createTabs();
            
            // Check environment and setup appropriate file loading
            if (!window.fs || !window.fs.readFile) {
                // Show loading message for GitHub fetch
                document.getElementById('tableContent').innerHTML = `
                    <div class="loading">
                        <p>Loading referee data from GitHub...</p>
                        <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                            This may take a moment as we fetch all season files
                        </p>
                    </div>
                `;
            }
            
            await loadAllData();
            
            if (allData.length === 0) {
                // If no data loaded, show file input option
                document.getElementById('fileInputContainer').style.display = 'block';
                document.getElementById('tableContent').innerHTML = `
                    <div class="loading">
                        <p>Could not load data from GitHub</p>
                        <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                            Please use the "Load CSV Files" button above to manually load files
                        </p>
                    </div>
                `;
                
                // Setup file input handler
                document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            } else {
                updateView();
            }
        }
        
        // Handle manual file selection
        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            // Clear existing data
            allData = [];
            
            // Process each file
            for (const file of files) {
                const seasonId = detectSeasonFromFilename(file.name);
                const content = await readFileContent(file);
                processCSVContent(content, seasonId, file.name);
            }
            
            console.log(`Loaded ${allData.length} total records from ${files.length} files`);
            updateView();
        }
        
        // Read file content
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        // Detect season from filename
        function detectSeasonFromFilename(filename) {
            for (const season of seasons) {
                if (season.files.some(f => filename.includes(f.replace('.csv', '')))) {
                    return season.id;
                }
            }
            return 'unknown';
        }
        
        // Process CSV content
        function processCSVContent(content, seasonId, filename) {
            const lines = content.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            // Find duplicate columns
            const headerCounts = {};
            headers.forEach((header) => {
                if (!headerCounts[header]) {
                    headerCounts[header] = [];
                }
                headerCounts[header].push(headers.indexOf(header));
            });
            
            // Process each data line
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const row = parseRow(headers, values, headerCounts);
                if (row) {
                    row.season = seasonId;
                    row.filename = filename;
                    allData.push(row);
                }
            }
        }
        
        // Create tab structure
        function createTabs() {
            const mainTabsContainer = document.getElementById('mainTabs');
            
            // All Time tab
            const allTimeTab = document.createElement('button');
            allTimeTab.className = 'tab active';
            allTimeTab.textContent = 'All Time';
            allTimeTab.onclick = () => setMainTab('all-time');
            mainTabsContainer.appendChild(allTimeTab);
            
            // Season tabs
            seasons.forEach(season => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.textContent = season.label;
                tab.onclick = () => setMainTab(season.id);
                mainTabsContainer.appendChild(tab);
            });
            
            // Tournament Usage tab
            const tournamentTab = document.createElement('button');
            tournamentTab.className = 'tab';
            tournamentTab.textContent = 'Tournament Usage';
            tournamentTab.onclick = () => setMainTab('tournaments');
            mainTabsContainer.appendChild(tournamentTab);
        }
        
        // Load all CSV data
        async function loadAllData() {
            const loadPromises = [];
            let successCount = 0;
            let totalFiles = 0;
            
            for (const season of seasons) {
                for (const file of season.files) {
                    totalFiles++;
                    loadPromises.push(
                        loadCSV(file, season.id).then(() => {
                            successCount++;
                            // Update loading progress
                            if (document.getElementById('tableContent').classList.contains('loading')) {
                                document.getElementById('tableContent').innerHTML = `
                                    <div class="loading">
                                        <p>Loading referee data from GitHub...</p>
                                        <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                                            Loaded ${successCount} of ${totalFiles} files
                                        </p>
                                    </div>
                                `;
                            }
                        })
                    );
                }
            }
            
            await Promise.all(loadPromises);
            console.log(`Successfully loaded ${successCount} of ${totalFiles} files with ${allData.length} total records`);
        }
        
        // Load individual CSV file
        async function loadCSV(filename, seasonId) {
            try {
                let response;
                
                // Try different methods to load the file
                if (window.fs && window.fs.readFile) {
                    // Claude artifact environment
                    response = await window.fs.readFile(filename, { encoding: 'utf8' });
                } else {
                    // Standard web environment - try fetch
                    try {
                        const fetchResponse = await fetch(filename);
                        if (!fetchResponse.ok) {
                            throw new Error(`HTTP error! status: ${fetchResponse.status}`);
                        }
                        response = await fetchResponse.text();
                    } catch (fetchError) {
                        console.warn(`Could not fetch ${filename}:`, fetchError);
                        return; // Skip this file
                    }
                }
                }
                
                const lines = response.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Find duplicate columns
                const headerCounts = {};
                headers.forEach((header) => {
                    if (!headerCounts[header]) {
                        headerCounts[header] = [];
                    }
                    headerCounts[header].push(headers.indexOf(header));
                });
                
                // Process each data line
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',');
                    const row = parseRow(headers, values, headerCounts);
                    if (row) {
                        row.season = seasonId;
                        row.filename = filename;
                        allData.push(row);
                    }
                }
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
            }
        }
        
        // Parse a single row handling duplicate columns
        function parseRow(headers, values, headerCounts) {
            const row = {
                lastName: '',
                firstName: '',
                date: '',
                event: '',
                pools: 0,
                table512: 0,
                table256: 0,
                table128: 0,
                table64: 0,
                table32: 0,
                table16: 0,
                table8: 0,
                semiFinals: 0,
                bronzeMedal: 0,
                finals: 0,
                videoRef: 0,
                mainRef: 0
            };
            
            // Process each header
            headers.forEach((header, index) => {
                const value = values[index] ? values[index].trim() : '';
                
                switch(header) {
                    case 'Last Name':
                    case '':  // Some files use empty string for last name
                        if (value) row.lastName = value;
                        break;
                    case 'First Name':
                        row.firstName = value;
                        break;
                    case 'Date':
                        row.date = value;
                        break;
                    case 'Event':
                        row.event = value;
                        break;
                    case 'Pools':
                        row.pools += extractRefCount(value);
                        break;
                    case 'Table of 512':
                        row.table512 += extractRefCount(value);
                        break;
                    case 'Table of 256':
                        row.table256 += extractRefCount(value);
                        break;
                    case 'Table of 128':
                        row.table128 += extractRefCount(value);
                        break;
                    case 'Table of 64':
                        row.table64 += extractRefCount(value);
                        break;
                    case 'Table of 32':
                        row.table32 += extractRefCount(value);
                        break;
                    case 'Table of 16':
                        row.table16 += extractRefCount(value);
                        break;
                    case 'Table of 8':
                        row.table8 += extractRefCount(value);
                        break;
                    case 'Semi-Finals':
                        row.semiFinals += extractRefCount(value);
                        break;
                    case 'Bronze Medal Matches':
                        row.bronzeMedal += extractRefCount(value);
                        break;
                    case 'Finals':
                        row.finals += extractRefCount(value);
                        break;
                }
                
                // Track video vs main ref
                if (value.includes('Video:')) {
                    row.videoRef += extractRefCount(value);
                } else if (value.includes('Ref:')) {
                    row.mainRef += extractRefCount(value);
                }
            });
            
            // Calculate total bouts (excluding pools)
            row.totalBouts = row.table512 + row.table256 + row.table128 + row.table64 + 
                           row.table32 + row.table16 + row.table8 + row.semiFinals + 
                           row.bronzeMedal + row.finals;
            
            // Calculate top 8 bouts (quarterfinals, semifinals, and finals)
            row.top8Bouts = row.table8 + row.semiFinals + row.finals;
            
            // Extract weapon from event code
            row.weapon = extractWeapon(row.event);
            
            // Parse date for tournament detection
            row.parsedDate = parseDate(row.date);
            
            return row;
        }
        
        // Extract referee count from cell value
        function extractRefCount(value) {
            if (!value) return 0;
            const match = value.match(/(?:Ref:|Video:)\s*(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }
        
        // Extract weapon from event code
        function extractWeapon(event) {
            if (!event) return 'unknown';
            const upper = event.toUpperCase();
            if (upper.includes('MF') || upper.includes('WF')) return 'foil';
            if (upper.includes('ME') || upper.includes('WE')) return 'epee';
            if (upper.includes('MS') || upper.includes('WS')) return 'saber';
            return 'unknown';
        }
        
        // Parse date string
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return {
                    month: parseInt(parts[0]),
                    day: parseInt(parts[1]),
                    year: parseInt(parts[2])
                };
            }
            return null;
        }
        
        // Set main tab
        function setMainTab(tabId) {
            currentView = tabId;
            currentSubView = 'all';
            
            // Update tab styling
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide subtabs
            const subtabsContainer = document.getElementById('subtabs');
            if (tabId === 'tournaments' || tabId.includes('-')) {
                subtabsContainer.classList.add('active');
                createSubtabs();
            } else {
                subtabsContainer.classList.remove('active');
            }
            
            updateView();
        }
        
        // Create weapon subtabs
        function createSubtabs() {
            const subtabsContainer = document.getElementById('subtabs');
            subtabsContainer.innerHTML = '';
            
            Object.entries(weapons).forEach(([key, label]) => {
                const subtab = document.createElement('button');
                subtab.className = 'subtab' + (key === currentSubView ? ' active' : '');
                subtab.textContent = label;
                subtab.onclick = () => {
                    currentSubView = key;
                    document.querySelectorAll('.subtab').forEach(st => st.classList.remove('active'));
                    subtab.classList.add('active');
                    updateView();
                };
                subtabsContainer.appendChild(subtab);
            });
        }
        
        // Update the view based on current selection
        function updateView() {
            let filteredData = [...allData];
            
            // Filter by view type
            if (currentView !== 'all-time' && currentView !== 'tournaments') {
                // Season view
                filteredData = filteredData.filter(row => row.season === currentView);
            } else if (currentView === 'tournaments') {
                // Tournament view - will be handled differently
            }
            
            // Filter by weapon
            if (currentSubView !== 'all') {
                filteredData = filteredData.filter(row => row.weapon === currentSubView);
            }
            
            // Aggregate referee data
            const refereeStats = aggregateRefereeData(filteredData);
            
            // Display stats and table
            displayStats(refereeStats);
            displayTable(refereeStats);
        }
        
        // Aggregate referee data
        function aggregateRefereeData(data) {
            const refereeMap = {};
            
            data.forEach(row => {
                const key = `${row.lastName}_${row.firstName}`;
                if (!refereeMap[key]) {
                    refereeMap[key] = {
                        lastName: row.lastName,
                        firstName: row.firstName,
                        totalBouts: 0,
                        pools: 0,
                        finals: 0,
                        videoRef: 0,
                        mainRef: 0,
                        top8Bouts: 0,
                        events: new Set(),
                        tournaments: new Set(),
                        seasons: new Set()
                    };
                }
                
                const ref = refereeMap[key];
                ref.totalBouts += row.totalBouts;
                ref.pools += row.pools;
                ref.finals += row.finals;
                ref.videoRef += row.videoRef;
                ref.mainRef += row.mainRef;
                ref.top8Bouts += row.top8Bouts;
                ref.events.add(row.event);
                ref.seasons.add(row.season);
                
                // Determine tournament
                if (row.parsedDate) {
                    const tournament = getTournament(row.parsedDate);
                    if (tournament) {
                        ref.tournaments.add(`${tournament}_${row.season}`);
                    }
                }
            });
            
            // Convert to array and calculate percentages
            return Object.values(refereeMap).map(ref => ({
                ...ref,
                eventCount: ref.events.size,
                tournamentCount: ref.tournaments.size,
                videoPercentage: ref.mainRef > 0 ? ((ref.videoRef / (ref.videoRef + ref.mainRef)) * 100).toFixed(1) : '0.0'
            }));
        }
        
        // Get tournament from date
        function getTournament(parsedDate) {
            for (const tournament of tournaments) {
                if (tournament.months && tournament.months.includes(parsedDate.month)) {
                    return tournament.id;
                } else if (tournament.dateRange) {
                    // Check Summer Nationals date range
                    const dateStr = `${String(parsedDate.month).padStart(2, '0')}/${String(parsedDate.day).padStart(2, '0')}`;
                    if (dateStr >= tournament.dateRange.start && dateStr <= tournament.dateRange.end) {
                        return tournament.id;
                    }
                }
            }
            return null;
        }
        
        // Display statistics
        function displayStats(refereeStats) {
            const statsContainer = document.getElementById('statsContainer');
            const totalReferees = refereeStats.length;
            const totalBouts = refereeStats.reduce((sum, ref) => sum + ref.totalBouts, 0);
            const totalFinals = refereeStats.reduce((sum, ref) => sum + ref.finals, 0);
            
            statsContainer.innerHTML = `
                <div class="stats-card">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${totalReferees}</div>
                            <div class="stat-label">Total Referees</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${totalBouts.toLocaleString()}</div>
                            <div class="stat-label">Total Bouts</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${totalFinals}</div>
                            <div class="stat-label">Total Finals</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Display table
        function displayTable(refereeStats) {
            const tableContent = document.getElementById('tableContent');
            
            // Sort data
            const sortedData = sortData(refereeStats);
            
            // Filter by search
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredData = sortedData.filter(ref => 
                ref.lastName.toLowerCase().includes(searchTerm) ||
                ref.firstName.toLowerCase().includes(searchTerm)
            );
            
            // Create table
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="setSortColumn('lastName')">Last Name</th>
                            <th class="sortable" onclick="setSortColumn('firstName')">First Name</th>
                            <th class="sortable" onclick="setSortColumn('totalBouts')">Total Bouts</th>
                            <th class="sortable" onclick="setSortColumn('pools')">Pools</th>
                            <th class="sortable" onclick="setSortColumn('finals')">Finals</th>
                            <th class="sortable" onclick="setSortColumn('mainRef')">Ref</th>
                            <th class="sortable" onclick="setSortColumn('videoRef')">Video Ref</th>
                            <th class="sortable" onclick="setSortColumn('videoPercentage')">Video %</th>
                            <th class="sortable" onclick="setSortColumn('top8Bouts')">Top 8</th>
                            <th class="sortable" onclick="setSortColumn('eventCount')">Events</th>
                            <th class="sortable" onclick="setSortColumn('tournamentCount')">Tournaments</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add rows (limit to top 100 for performance)
            filteredData.slice(0, 100).forEach(ref => {
                html += `
                    <tr>
                        <td>${ref.lastName}</td>
                        <td>${ref.firstName}</td>
                        <td>${ref.totalBouts}</td>
                        <td>${ref.pools}</td>
                        <td>${ref.finals}</td>
                        <td>${ref.mainRef}</td>
                        <td>${ref.videoRef}</td>
                        <td>${ref.videoPercentage}%</td>
                        <td>${ref.top8Bouts}</td>
                        <td>${ref.eventCount}</td>
                        <td>${ref.tournamentCount}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            tableContent.innerHTML = html;
            
            // Update sort indicators
            updateSortIndicators();
        }
        
        // Sort data
        function sortData(data) {
            if (!sortColumn) {
                sortColumn = 'totalBouts';
            }
            
            return [...data].sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];
                
                // Handle numeric vs string sorting
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }
        
        // Set sort column
        function setSortColumn(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            updateView();
        }
        
        // Update sort indicators
        function updateSortIndicators() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            const currentTh = document.querySelector(`th[onclick*="${sortColumn}"]`);
            if (currentTh) {
                currentTh.classList.add(`sorted-${sortDirection}`);
            }
        }
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', () => {
            updateView();
        });
        
        // Initialize dashboard
        init();
    </script>
</body>
</html>